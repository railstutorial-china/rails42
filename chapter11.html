<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>Ruby on Rails 教程 - 第 11 章 用户的微博</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="最好的 Ruby on Rails 入门教程"/>
    <meta name="keywords" content="ruby, rails, tutorial"/>
    <meta name="author" content="Michael Hartl"/>
    <meta name="translator" content="安道"/>
    <meta name="generator" content="persie 0.0.1.beta.3"/>
    <link rel="stylesheet" type="text/css" href="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/style.css"/>
    <script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/js/collapse.min.js"></script>
    <script type="text/javascript" src="assets/global.js"></script>
</head>
<body>

<header class="navbar navbar-default navbar-fixed-top navbar-book">
    <div class="container">
        <div class="navbar-header">
            <a href="http://railstutorial-china.org" class="navbar-brand">Ruby on Rails 教程</a>
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".book-navbar-collapse">
                <span class="sr-only">导航</span>
                <i class="fa fa-bars"></i>
            </button>
            <a href="http://railstutorial-china.org/#purchase" id="navbar-purchase-xs" class="btn btn-warning navbar-btn visible-xs collapsed-purchase-btn">购买</a>
        </div>
        <nav class="collapse navbar-collapse book-navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://railstutorial-china.org" title="首页">首页</a></li>
                <li class="active"><a href="http://railstutorial-china.org/read/" title="在线阅读">阅读</a></li>
                <li><a href="http://railstutorial-china.org/blog/" title="最新消息">博客</a></li>
                <li><a href="https://selfstore.io/products/189/topics" title="论坛">论坛</a></li>
                <li class="hidden-xs"><div><a href="http://railstutorial-china.org/#purchase" id="navbar-purchase" class="btn btn-warning navbar-btn" title="购买电子书">购买</a></div></li>
            </ul>
        </nav>
    </div>
</header>

<div class="content">
    <div class="container">
        <div class="row">
            <div class="col-lg-offset-2 col-lg-8">
                <div class="alert alert-warning">
                    <p>在线版的内容可能落后于电子书，如果想及时获得更新，请<a href="http://railstutorial-china.org/#purchase" title="购买电子书">购买电子书</a>。</p>
                </div>
                <article class="article">
                    <section data-type="chapter" id="user-microposts">
<h1><span class="title-label">第 11 章</span> 用户的微博</h1>
<p>在开发这个演示应用的过程中，我们用到了四个资源：用户，会话，账户激活和密码重设。但只有第一个资源通过 Active Record 模型对应了数据库中的表。本章，我们要再实现一个这样的资源——用户的微博，即用户发布的短消息。<a href="chapter2.html#a-toy-app">第 2 章</a>实现了微博的雏形，本章则会在 <a href="chapter2.html#the-microposts-resource">2.3 节</a>的基础上，实现一个功能完整的微博资源。首先，我们要创建微博数据模型，通过  <code>has_many</code> 和 <code>belongs_to</code> 方法把微博和用户关联起来，然后再创建处理和显示微博所需的表单及局部视图（<a href="#micropost-images">11.4 节</a>还要实现上传图片功能）。在<a href="chapter12.html#following-users">第 12 章</a>，还要加入关注其他用户的功能，届时，我们这个山寨版 Twitter 才算完成。</p>
<section data-type="sect1" id="a-micropost-model">
<h1><span class="title-label">11.1</span> 微博模型</h1>
<p>实现微博资源的第一步是创建微博数据模型，在模型中设定微博的基本特征。和 <a href="chapter2.html#the-microposts-resource">2.3 节</a>创建的模型类似，我们要实现的微博模型要包含数据验证，以及和用户模型之间的关联。除此之外，我们还会做充分的测试，指定默认的排序方式，以及自动删除已注销用户的微博。</p>
<p>如果使用 Git 做版本控制的话，和之前一样，建议你新建一个主题分支：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git checkout -b user-microposts
</pre></div>
</div>
<section data-type="sect2" id="the-basic-model">
<h2><span class="title-label">11.1.1</span> 基本模型</h2>
<p>微博模型只需要两个属性：一个是 <code>content</code>，用来保存微博的内容；另一个是 <code>user_id</code>，把微博和用户关联起来。微博模型的结构如<a href="#fig-micropost-model">图 11.1</a> 所示。</p>
<div id="fig-micropost-model" class="figure"><img src="images/chapter11/micropost_model_3rd_edition.png" alt="micropost model 3rd edition" /><div class="figcaption"><span class="title-label">图 11.1</span>：微博数据模型</div></div>
<p>注意，在这个模型中，<code>content</code> 属性的类型为 <code>text</code>，而不是 <code>string</code>，目的是存储任意长度的文本。虽然我们会限制微博内容的长度不超过 140 个字符（<a href="#micropost-validations">11.1.2 节</a>），也就是说在 <code>string</code> 类型的 255 个字符长度的限制内，但使用 <code>text</code> 能更好地表达微博的特性，即把微博看成一段文本更符合常理。在 <a href="#creating-microposts">11.3.2 节</a>，会把文本字段换成多行文本字段，用于提交微博。而且，如果以后想让微博的内容更长一些（例如包含多国文字），使用 <code>text</code> 类型处理起来更灵活。何况，在生产环境中使用 <code>text</code> 类型并<a href="http://www.postgresql.org/docs/9.1/static/datatype-character.html">没有什么性能差异</a>，所以不会有什么额外消耗。</p>
<p>和用户模型一样（<a href="chapter6.html#listing-generate-user-model">代码清单 6.1</a>），我们要使用 <code>generate model</code> 命令生成微博模型：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate model Micropost content:text user:references
</pre></div>
</div>
<p>这个命令会生成一个迁移文件，用于在数据库中生成一个名为 <code>microposts</code> 的表，如<a href="#listing-micropost-migration">代码清单 11.1</a> 所示。可以和生成 <code>users</code> 表的迁移对照一下，参见<a href="chapter6.html#listing-users-migration">代码清单 6.2</a>。二者之间最大的区别是，前者使用了 <code>references</code> 类型。<code>references</code> 会自动添加 <code>user_id</code> 列（以及索引），把用户和微博关联起来。和用户模型一样，微博模型的迁移中也自动生成了 <code>t.timestamps</code>。<a href="chapter6.html#database-migrations">6.1.1 节</a>说过，这行代码的作用是添加 <code>created_at</code> 和 <code>updated_at</code> 两列。（<a href="#micropost-refinements">11.1.4 节</a>和 <a href="#rendering-microposts">11.2.1 节</a>会使用 <code>created_at</code> 列。）</p>
<div id="listing-micropost-migration" data-type="listing">
<h5><span class="title-label">代码清单 11.1</span>：微博模型的迁移文件，还创建了索引</h5>

<div class="source-file">db/migrate/[timestamp]_create_microposts.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="kp">true</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>因为我们会按照发布时间的倒序查询某个用户发布的所有微博，所以在上述代码中为 <code>user_id</code> 和 <code>created_at</code> 列创建了索引（参见<a href="chapter6.html#aside-database-indices">旁注 6.2</a>）：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>
<p>我们把 <code>user_id</code> 和 <code>created_at</code> 放在一个数组中，告诉 Rails 我们要创建的是“多键索引”（multiple key index），因此 Active Record 会同时使用这两个键。</p>
<p>然后像之前一样，执行下面的命令更新数据库：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>
</section>
<section data-type="sect2" id="micropost-validations">
<h2><span class="title-label">11.1.2</span> 微博模型的数据验证</h2>
<p>我们已经创建了基本的数据模型，下面要添加一些验证，实现符合需求的约束。微博模型必须要有一个属性表示用户的 ID，这样才能知道某篇微博是由哪个用户发布的。实现这样的属性，最好的方法是使用 Active Record 关联。<a href="#user-micropost-associations">11.1.3 节</a>会实现关联，现在我们直接处理微博模型。</p>
<p>我们可以参照用户模型的测试（<a href="chapter6.html#listing-name-presence-test">代码清单 6.7</a>），在 <code>setup</code> 方法中新建一个微博对象，并把它和固件中的一个有效用户关联起来，然后在测试中检查这个微博对象是否有效。因为每篇微博都要和用户关联起来，所以我们还要为 <code>user_id</code> 属性的存在性验证编写一个测试。综上所述，测试如<a href="#listing-micropost-validity-test">代码清单 11.2</a> 所示。</p>
<div id="listing-micropost-validity-test" data-type="listing">
<h5><span class="title-label">代码清单 11.2</span>：测试微博是否有效 <span class="red">RED</span></h5>

<div class="source-file">test/models/micropost_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="c1"># 这行代码不符合常见做法</span>
</span><span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如 <code>setup</code> 方法中的注释所说，创建微博使用的方法不符合常见做法，我们会在 <a href="#user-micropost-associations">11.1.3 节</a>修正。</p>
<p>微博是否有效的测试能通过，但用户 ID 存在性验证的测试无法通过，因为微博模型目前还没有任何验证规则：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.3</span>：<strong class="red">RED</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:models
</pre></div>
</div>
<p>为了让测试通过，我们要添加用户 ID 存在性验证，如<a href="#listing-micropost-user-id-validation">代码清单 11.4</a> 所示。（注意，这段代码中 <code>belongs_to</code> 那行由<a href="#listing-micropost-migration">代码清单 11.1</a> 中的迁移自动生成。<a href="#user-micropost-associations">11.1.3 节</a>会深入介绍这行代码的作用。）</p>
<div id="listing-micropost-user-id-validation" data-type="listing">
<h5><span class="title-label">代码清单 11.4</span>：微博模型 <code>user_id</code> 属性的验证 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
   <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="hll">   <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>现在，整个测试组件应该都能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.5</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>接下来，我们要为 <code>content</code> 属性加上数据验证（参照 <a href="chapter2.html#putting-the-micro-in-microposts">2.3.2 节</a>的做法）。和 <code>user_id</code> 一样，<code>content</code> 属性必须存在，而且还要限制内容的长度不能超过 140 个字符，这才是真正的“微”博。首先，我们要参照 <a href="chapter6.html#user-validations">6.2 节</a>用户模型的验证测试，编写一些简单的测试，如<a href="#listing-micropost-validations-tests">代码清单 11.6</a> 所示。</p>
<div id="listing-micropost-validations-tests" data-type="listing">
<h5><span class="title-label">代码清单 11.6</span>：测试微博模型的验证 <span class="red">RED</span></h5>

<div class="source-file">test/models/micropost_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"content should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"   "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"content should be at most 140 characters"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>和 <a href="chapter6.html#user-validations">6.2 节</a>一样，<a href="#listing-micropost-validations-tests">代码清单 11.6</a>也用到了字符串连乘来测试微博内容长度的验证：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">10</span>
<span class="go">=&gt; "aaaaaaaaaa"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div>
</div>
<p>在模型中添加的代码基本上和用户模型 <code>name</code> 属性的验证一样（<a href="chapter6.html#listing-length-validation">代码清单 6.16</a>），如<a href="#listing-micropost-validations">代码清单 11.7</a> 所示。</p>
<div id="listing-micropost-validations" data-type="listing">
<h5><span class="title-label">代码清单 11.7</span>：微博模型的验证 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>现在，测试组件应该能通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.8</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
<section data-type="sect2" id="user-micropost-associations">
<h2><span class="title-label">11.1.3</span> 用户和微博之间的关联</h2>
<p>为 Web 应用构建数据模型时，最基本的要求是要能够在不同的模型之间建立关联。在这个应用中，每篇微博都属于某个用户，而每个用户一般都有多篇微博。用户和微博之间的关系在 <a href="chapter2.html#a-user-has-many-microposts">2.3.3 节</a>简单介绍过，如<a href="#fig-micropost-belongs-to-user">图 11.2</a> 和<a href="#fig-user-has-many-microposts">图 11.3</a> 所示。在实现这种关联的过程中，我们会为微博模型和用户模型编写一些测试。</p>
<div id="fig-micropost-belongs-to-user" class="figure"><img src="images/chapter11/micropost_belongs_to_user.png" alt="micropost belongs to user" /><div class="figcaption"><span class="title-label">图 11.2</span>：微博和所属用户之间的 <code>belongs_to</code>（属于）关系</div></div>
<div id="fig-user-has-many-microposts" class="figure"><img src="images/chapter11/user_has_many_microposts.png" alt="user has many microposts" /><div class="figcaption"><span class="title-label">图 11.3</span>：用户和微博之间的 <code>has_many</code>（拥有多个）关系</div></div>
<p>使用本节实现的 <code>belongs_to</code>/<code>has_many</code> 关联之后，Rails 会自动创建一些方法，如<a href="#table-association-methods">表 11.1</a> 所示。注意，从表中可知，相较于下面的方法</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>
<p>我们得到了</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>
<p>后者才是创建微博的正确方式，即通过相关联的用户对象创建。通过这种方式创建的微博，其 <code>user_id</code> 属性会自动设为正确的值。所以，我们可以把<a href="#listing-micropost-validity-test">代码清单 11.2</a> 中的下述代码</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="c1"># 这行代码不符合常见做法</span>
<span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>改为</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
</pre></div>
</div>
<p>（和 <code>new</code> 方法一样，<code>build</code> 方法返回一个存储在内存中的对象，不会修改数据库。）只要关联定义的正确，<code>@micropost</code> 变量的 <code>user_id</code> 属性就会自动设为所关联用户的 ID。</p>
<table id="table-association-methods" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 11.1</span>：用户和微博之间建立关联后得到的方法简介</caption>
<colgroup>
<col style="width: 50%;" />
<col style="width: 50%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">方法</th>
<th class="tableblock halign-left valign-top">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>micropost.user</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返回和微博关联的用户对象</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.microposts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返回用户发布的所有微博</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.microposts.create(arg)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">创建一篇 <code>user</code> 发布的微博</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.microposts.create!(arg)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">创建一篇 <code>user</code> 发布的微博（失败时抛出异常）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.microposts.build(arg)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">返回一个 <code>user</code> 发布的新微博对象</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.microposts.find_by(id: 1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">查找 <code>user</code> 发布的一篇微博，而且微博的 ID 为 1</p></td>
</tr>
</tbody>
</table>
<p>为了让 <code>@user.microposts.build</code> 这样的代码能使用，我们要修改用户模型和微博模型，添加一些代码，把这两个模型关联起来。<a href="#listing-micropost-migration">代码清单 11.1</a> 中的迁移已经自动添加了 <code>belongs_to :user</code>，如<a href="#listing-micropost-belongs-to-user">代码清单 11.9</a> 所示。关联的另一头，<code>has_many :microposts</code>，我们要自己动手添加，如<a href="#listing-user-has-many-microposts">代码清单 11.10</a> 所示。</p>
<div id="listing-micropost-belongs-to-user" data-type="listing">
<h5><span class="title-label">代码清单 11.9</span>：一篇微博属于（<code>belongs_to</code>）一个用户 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-user-has-many-microposts" data-type="listing">
<h5><span class="title-label">代码清单 11.10</span>：一个用户有多篇（<code>has_many</code>）微博 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:microposts</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>定义好关联后，我们可以修改<a href="#listing-micropost-validity-test">代码清单 11.2</a> 中的 <code>setup</code> 方法了，使用正确的方式创建一个微博对象，如<a href="#listing-micropost-validity-test-idiomatic">代码清单 11.11</a> 所示。</p>
<div id="listing-micropost-validity-test-idiomatic" data-type="listing">
<h5><span class="title-label">代码清单 11.11</span>：使用正确的方式创建微博对象 <span class="green">GREEN</span></h5>

<div class="source-file">test/models/micropost_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"user id should be present"</span> <span class="k">do</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>当然，经过这次简单的重构后测试组件应该还能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.12</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
<section data-type="sect2" id="micropost-refinements">
<h2><span class="title-label">11.1.4</span> 改进微博模型</h2>
<p>本节，我们要改进一下用户和微博之间的关联：按照特定的顺序取回用户的微博，并且让微博依属于用户，如果用户注销了，就自动删除这个用户发布的所有微博。</p>
<section data-type="sect3" id="default-scope">
<h3>默认作用域</h3>
<p>默认情况下，<code>user.microposts</code> 不能确保微博的顺序，但是按照博客和 Twitter 的习惯，我们希望微博按照创建时间倒序排列，也就是最新发布的微博在前面。<sup>[<a id="fn-ref-1" href="#fn-1">1</a>]</sup>为此，我们要使用“默认作用域”（default scope）。</p>
<p>这样的功能很容易让测试意外通过（就算应用代码不对，测试也能通过），所以我们要使用测试驱动开发技术，确保实现的方式是正确的。首先，我们编写一个测试，检查数据库中的第一篇微博和微博固件中名为 <code>most_recent</code> 的微博相同，如<a href="#listing-micropost-order-test">代码清单 11.13</a> 所示。</p>
<div id="listing-micropost-order-test" data-type="listing">
<h5><span class="title-label">代码清单 11.13</span>：测试微博的排序 <span class="red">RED</span></h5>

<div class="source-file">test/models/micropost_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"order should be most recent first"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:most_recent</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>这段代码要使用微博固件，所以我们要定义固件，如<a href="#listing-micropost-fixtures">代码清单 11.14</a> 所示。</p>
<div id="listing-micropost-fixtures" data-type="listing">
<h5><span class="title-label">代码清单 11.14</span>：微博固件</h5>

<div class="source-file">test/fixtures/microposts.yml</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>

<span class="l-Scalar-Plain">tau_manifesto</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Check</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">@tauday</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">@mhartl:</span><span class="nv"> </span><span class="s">http://tauday.com"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.years.ago %&gt;</span>

<span class="l-Scalar-Plain">cat_video</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Sad</span><span class="nv"> </span><span class="s">cats</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">sad:</span><span class="nv"> </span><span class="s">http://youtu.be/PKffm2uI4dk"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.hours.ago %&gt;</span>

<span class="l-Scalar-Plain">most_recent</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Writing</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">short</span><span class="nv"> </span><span class="s">test"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</pre></div>
</div>
<p>注意，我们使用嵌入式 Ruby 明确设置了 <code>created_at</code> 属性的值。因为这个属性由 Rails 自动更新，一般无法手动设置，但在固件中可以这么做。实际上可能不用自己设置这些属性，因为在某些系统中固件会按照定义的顺序创建。在这个文件中，最后一个固件最后创建（因此是最新的一篇微博）。但是绝不要依赖这种行为，因为并不可靠，而且在不同的系统中有差异。</p>
<p>现在，测试应该无法通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.15</span>：<strong class="red">RED</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test </span><span class="nv">TEST</span><span class="o">=</span><span class="nb">test</span>/models/micropost_test.rb <span class="se">\</span>
&gt;                       <span class="nv">TESTOPTS</span><span class="o">=</span><span class="s2">"--name test_order_should_be_most_recent_first"</span>
</pre></div>
</div>
<p>我们要使用 Rails 提供的 <code>default_scope</code> 方法让测试通过。这个方法的作用很多，这里我们要用它设定从数据库中读取数据的默认顺序。为了得到特定的顺序，我们要在 <code>default_scope</code> 方法中指定 <code>order</code> 参数，按 <code>created_at</code> 列的值排序，如下所示：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
</pre></div>
</div>
<p>可是，这实现的是“升序”，从小到大排列，即最早发布的微博排在最前面。为了让微博降序排列，我们要向下走一层，使用纯 SQL 语句：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span>
</pre></div>
</div>
<p>在 SQL 中，<code>DESC</code> 表示“降序”，即新发布的微博在前面。在以前的 Rails 版本中，必须使用纯 SQL 语句才能实现这个需求，但从 Rails 4.0 起，可以使用纯 Ruby 句法实现：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
</pre></div>
</div>
<p>把默认作用域加入微博模型，如<a href="#listing-micropost-ordering">代码清单 11.16</a> 所示。</p>
<div id="listing-micropost-ordering" data-type="listing">
<h5><span class="title-label">代码清单 11.16</span>：使用 <code>default_scope</code> 排序微博 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="hll">  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-micropost-ordering">代码清单 11.16</a> 中使用了“箭头”句法，表示一种对象，叫 Proc（procedure）或 lambda，即“匿名函数”（没有名字的函数）。<code>-&gt;</code> 接受一个代码块（<a href="chapter4.html#blocks">4.3.2 节</a>），返回一个 Proc。然后在这个 Proc 上调用 <code>call</code> 方法执行其中的代码。我们可以在控制台中看一下怎么使用 Proc：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><span class="gp">&gt;&gt; </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">"foo"</span> <span class="p">}</span>
<span class="go">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<span class="gp">&gt;&gt; </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">"foo"</span> <span class="p">}</span><span class="o">.</span><span class="n">call</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>
<p>（Proc 是高级 Ruby 知识，如果现在不理解也不用担心。）</p>
<p>按照<a href="#listing-micropost-ordering">代码清单 11.16</a> 修改后，测试应该可以通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.17</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
<section data-type="sect3" id="dependent-destroy">
<h3>依属关系：destroy</h3>
<p>除了设定恰当的顺序外，我们还要对微博模型做一项改进。我们在 <a href="chapter9.html#deleting-users">9.4 节</a>介绍过，管理员有删除用户的权限。那么，在删除用户的同时，有必要把该用户发布的微博也删除。</p>
<p>为此，我们可以把一个参数传给 <code>has_many</code> 关联方法，如<a href="#listing-micropost-dependency">代码清单 11.18</a> 所示。</p>
<div id="listing-micropost-dependency" data-type="listing">
<h5><span class="title-label">代码清单 11.18</span>：确保用户的微博在删除用户的同时也被删除</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code>dependent: :destroy</code> 的作用是在用户被删除的时候，把这个用户发布的微博也删除。这么一来，如果管理员删除了用户，数据库中就不会出现无主的微博了。</p>
<p>我们可以为用户模型编写一个测试，证明<a href="#listing-micropost-dependency">代码清单 11.18</a> 中的代码是正确的。我们要保存一个用户（因此得到了用户的 ID），再创建一个属于这个用户的微博，然后检查删除用户后微博的数量有没有减少一个，如<a href="#listing-dependent-destroy-test">代码清单 11.19</a> 所示。（和<a href="chapter9.html#listing-delete-link-integration-test">代码清单 9.57</a> 中“删除”链接的集成测试对比一下。）</p>
<div id="listing-dependent-destroy-test" data-type="listing">
<h5><span class="title-label">代码清单 11.19</span>：测试 <code>dependent: :destroy</code> <span class="green">GREEN</span></h5>

<div class="source-file">test/models/user_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"associated microposts should be destroyed"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如果<a href="#listing-micropost-dependency">代码清单 11.18</a> 正确，测试组件就应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.20</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
</section>
</section>
<section data-type="sect1" id="showing-microposts">
<h1><span class="title-label">11.2</span> 显示微博</h1>
<p>尽管我们还没实现直接在网页中发布微博的功能（将在 <a href="#creating-microposts">11.3.2 节</a>实现），不过还是有办法显示微博，并对显示的内容进行测试。我们将按照 Twitter 的方式，不在微博资源的 <code>index</code> 页面显示用户的微博，而在用户资源的 <code>show</code> 页面显示，构思图如<a href="#fig-user-microposts-mockup">图 11.4</a> 所示。我们会先使用一些简单的 ERb 代码，在用户的资料页面显示微博，然后在 <a href="chapter9.html#sample-users">9.3.2 节</a>的种子数据中添加一些微博，这样才有内容可以显示。</p>
<div id="fig-user-microposts-mockup" class="figure"><img src="images/chapter11/user_microposts_mockup_3rd_edition.png" alt="user microposts mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 11.4</span>：显示有微博的资料页面构思图</div></div>
<section data-type="sect2" id="rendering-microposts">
<h2><span class="title-label">11.2.1</span> 渲染微博</h2>
<p>我们计划在用户的资料页面（<code>show.html.erb</code>）显示用户的微博，还要显示用户发布了多少篇微博。你会发现，很多做法和 <a href="chapter9.html#showing-all-users">9.3 节</a>列出所有用户时类似。</p>
<p>虽然 <a href="#manipulating-microposts">11.3 节</a>才会用到微博控制器，但马上就需要使用视图，所以现在就要生成控制器：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate controller Microposts
</pre></div>
</div>
<p>这一节的主要目的是渲染用户发布的所有微博。<a href="chapter9.html#partial-refactoring">9.3.5 节</a>用过这样的代码：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="x">&lt;ul class="users"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/ul&gt;</span>
</pre></div>
</div>
<p>这段代码会自动使用局部视图 <code>_user.html.erb</code> 渲染 <code>@users</code> 变量中的每个用户。同样地，我们要编写 <code>_micropost.html.erb</code> 局部视图，使用类似的方式渲染微博集合：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="x">&lt;ol class="microposts"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/ol&gt;</span>
</pre></div>
</div>
<p>注意，我们使用的是有序列表标签 <code>ol</code>（而不是无需列表 <code>ul</code>），因为微博是按照一定顺序显示的（按时间倒序）。相应的局部视图如<a href="#listing-micropost-partial">代码清单 11.21</a> 所示。</p>
<div id="listing-micropost-partial" data-type="listing">
<h5><span class="title-label">代码清单 11.21</span>：渲染单篇微博的局部视图</h5>

<div class="source-file">app/views/microposts/_micropost.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;li id="micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;span class="user"&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">  &lt;span class="content"&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">  &lt;span class="timestamp"&gt;</span>
<span class="x">    Posted </span><span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> ago.</span>
<span class="x">  &lt;/span&gt;</span>
<span class="x">&lt;/li&gt;</span>
</pre></div>
</div>
<p>这个局部视图使用了 <code>time_ago_in_words</code> 辅助方法，这个方法的作用应该很明显，效果会在 <a href="#sample-microposts">11.2.2 节</a>看到。<a href="#listing-micropost-partial">代码清单 11.21</a> 还为每篇微博指定了 CSS ID：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="x">&lt;li id="micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
</pre></div>
</div>
<p>这是好习惯，说不定以后要处理（例如使用 JavaScript）单篇微博呢。</p>
<p>接下来要解决显示大量微博的问题。我们可以使用 <a href="chapter9.html#pagination">9.3.3 节</a>显示大量用户的方法来解决这个问题，即使用分页。和前面一样，我们要使用 <code>will_paginate</code> 方法：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>如果和用户列表页面的代码（<a href="chapter9.html#listing-will-paginate-index-view">代码清单 9.41</a>）比较的话，会发现之前使用的代码是：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>前面之所以可以直接调用，是因为在用户控制器中，<code>will_paginate</code> 假定有一个名为 <code>@users</code> 的实例变量（<a href="chapter9.html#pagination">9.3.3 节</a>说过，这个变量所属的类应该是 <code>AvtiveRecord::Relation</code>）。现在，因为还在用户控制器中，但是我们要分页显示微博，所以必须明确地把 <code>@microposts</code> 变量传给 <code>will_paginate</code> 方法。当然了，我们还要在 <code>show</code> 动作中定义 <code>@microposts</code> 变量，如<a href="#listing-user-show-microposts-instance">代码清单 11.22</a> 所示。</p>
<div id="listing-user-show-microposts-instance" data-type="listing">
<h5><span class="title-label">代码清单 11.22</span>：在用户控制器的 <code>show</code> 动作中定义 <code>@microposts</code> 变量</h5>

<div class="source-file">app/controllers/users_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意看 <code>paginate</code> 方法是多么智能，甚至可以在关联上使用，从 <code>microposts</code> 表中取出每一页要显示的微博。</p>
<p>最后，还要显示用户发布的微博数量。我们可以使用 <code>count</code> 方法实现：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
<p>和 <code>paginate</code> 方法一样，<code>count</code> 方法也可以在关联上使用。<code>count</code> 的计数过程不是把所有微博都从数据库中读取出来，然后再在所得的数组上调用 <code>length</code> 方法，如果这样做的话，微博数量一旦很多，效率就会降低。其实，<code>count</code> 方法直接在数据库层计算，让数据库统计指定的 <code>user_id</code> 拥有多少微博。（所有数据库都会对这种操作做性能优化。如果统计数量仍然是应用的性能瓶颈，可以使用“<a href="http://railscasts.com/episodes/23-counter-cache-column">计数缓存</a>”进一步提速。）</p>
<p>综上所述，现在可以把微博添加到资料页面了，如<a href="#listing-user-show-microposts">代码清单 11.23</a> 所示。注意，<code>if @user.microposts.any?</code>（在<a href="chapter7.html#listing-errors-partial">代码清单 7.19</a> 中见过类似的用法）的作用是，如果用户没有发布微博，不显示一个空列表。</p>
<div id="listing-user-show-microposts" data-type="listing">
<h5><span class="title-label">代码清单 11.23</span>：在用户资料页面中加入微博</h5>

<div class="source-file">app/views/users/show.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;aside class="col-md-4"&gt;</span>
<span class="x">    &lt;section class="user_info"&gt;</span>
<span class="x">      &lt;h1&gt;</span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;/h1&gt;</span>
<span class="x">    &lt;/section&gt;</span>
<span class="x">  &lt;/aside&gt;</span>
<span class="hll"><span class="x">  &lt;div class="col-md-8"&gt;</span>
</span><span class="hll"><span class="x">    </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">      &lt;h3&gt;Microposts (</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="x">)&lt;/h3&gt;</span>
</span><span class="hll"><span class="x">      &lt;ol class="microposts"&gt;</span>
</span><span class="hll"><span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">      &lt;/ol&gt;</span>
</span><span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">  &lt;/div&gt;</span>
</span><span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>现在，我们可以查看一下修改后的用户资料页面，如<a href="#fig-user-profile-no-microposts">图 11.5</a>。可能会出乎你的意料，不过也是理所当然的，因为现在还没有微博。下面我们就来改变这种状况。</p>
<div id="fig-user-profile-no-microposts" class="figure"><img src="images/chapter11/user_profile_no_microposts_3rd_edition.png" alt="user profile no microposts 3rd edition" /><div class="figcaption"><span class="title-label">图 11.5</span>：添加显示微博的代码后用户的资料页面，但没有微博</div></div>
</section>
<section data-type="sect2" id="sample-microposts">
<h2><span class="title-label">11.2.2</span> 示例微博</h2>
<p>在 <a href="#rendering-microposts">11.2.1 节</a>，为了显示用户的微博，创建或修改了几个模板，但是结果有点不给力。为了改变这种状况，我们要在 <a href="chapter9.html#sample-users">9.3.2 节</a>用到的种子数据中加入一些微博。</p>
<p>为所有用户添加示例微博要花很长时间，所以我们决定只为前六个用户添加。为此，要使用 <code>take</code> 方法：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>调用 <code>order</code> 方法的作用是按照创建用户的顺序查找六个用户。</p>
<p>我们要分别为这六个用户创建 50 篇微博（数量要多于 30 个才能分页）。为了生成微博的内容，我们要使用 Faker 提供的 <a href="http://rubydoc.info/gems/faker/1.3.0/Faker/Lorem"><code>Lorem.sentence</code></a> 方法。<sup>[<a id="fn-ref-2" href="#fn-2">2</a>]</sup>添加示例微博后的种子数据如<a href="#listing-sample-microposts">代码清单 11.24</a> 所示。</p>
<div id="listing-sample-microposts" data-type="listing">
<h5><span class="title-label">代码清单 11.24</span>：添加示例微博</h5>

<div class="source-file">db/seeds.rb</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">users = User.order(:created_at).take(6)</span>
<span class="l-Scalar-Plain">50.times do</span>
  <span class="l-Scalar-Plain">content = Faker::Lorem.sentence(5)</span>
  <span class="l-Scalar-Plain">users.each { |user| user.microposts.create!(content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">content) }</span>
<span class="l-Scalar-Plain">end</span>
</pre></div>
</div>
<p>然后，像之前一样重新把种子数据写入开发数据库：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate:reset
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:seed
</pre></div>
</div>
<p>完成后还要重启 Rails 开发服务器。</p>
<p>现在，我们能看到 <a href="#rendering-microposts">11.2.1 节</a>的劳动成果了——用户资料页面显示了微博。<sup>[<a id="fn-ref-3" href="#fn-3">3</a>]</sup>初步结果如<a href="#fig-user-profile-microposts-no-styling">图 11.6</a> 所示。</p>
<div id="fig-user-profile-microposts-no-styling" class="figure"><img src="images/chapter11/user_profile_microposts_no_styling_3rd_edition.png" alt="user profile microposts no styling 3rd edition" /><div class="figcaption"><span class="title-label">图 11.6</span>：用户资料页面显示的微博，还没添加样式</div></div>
<p><a href="#fig-user-profile-microposts-no-styling">图 11.6</a> 中显示的微博还没有样式，那我们就加入一些样式，如<a href="#listing-micropost-css">代码清单 11.25</a> 所示，<sup>[<a id="fn-ref-4" href="#fn-4">4</a>]</sup>然后再看一下页面显示的效果。</p>
<div id="listing-micropost-css" data-type="listing">
<h5><span class="title-label">代码清单 11.25</span>：微博的样式（包含本章要使用的所有 CSS）</h5>

<div class="source-file">app/assets/stylesheets/custom.css.scss</div>

<div class="highlight language-scss"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.user</span> <span class="p">{</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">em</span><span class="p">;</span>
    <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.content</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
    <span class="nt">img</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">padding</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nc">.timestamp</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$gray-light</span><span class="p">;</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nt">span</span><span class="nc">.picture</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nt">input</span> <span class="p">{</span>
    <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a href="#fig-user-profile-with-microposts">图 11.7</a> 是第一个用户的资料页面，<a href="#fig-other-profile-with-microposts">图 11.8</a> 是另一个用户的资料页面，<a href="#fig-user-profile-microposts">图 11.9</a> 是第一个用户资料页面的第 2 页，页面底部还显示了分页链接。注意观察这三幅图，可以看到，微博后面显示了距离发布的时间（例如，“Posted 1 minute ago.”），这就是<a href="#listing-micropost-partial">代码清单 11.21</a> 中 <code>time_ago_in_words</code> 方法实现的效果。过一会再刷新页面，这些文字会根据当前时间自动更新。</p>
<div id="fig-user-profile-with-microposts" class="figure"><img src="images/chapter11/user_profile_with_microposts_3rd_edition.png" alt="user profile with microposts 3rd edition" /><div class="figcaption"><span class="title-label">图 11.7</span>：显示有微博的用户资料页面（<a href="http://localhost:3000/users/1">/users/1</a>）</div></div>
<div id="fig-other-profile-with-microposts" class="figure"><img src="images/chapter11/other_profile_with_microposts_3rd_edition.png" alt="other profile with microposts 3rd edition" /><div class="figcaption"><span class="title-label">图 11.8</span>：另一个用户的资料页面（<a href="http://localhost:3000/users/5">/users/5</a>），也显示有微博</div></div>
<div id="fig-user-profile-microposts" class="figure"><img src="images/chapter11/user_profile_microposts_page_2_3rd_edition.png" alt="user profile microposts page 2 3rd edition" /><div class="figcaption"><span class="title-label">图 11.9</span>：微博分页链接（<a href="http://localhost:3000/users/1?page=2">/users/1?page=2</a>）</div></div>
</section>
<section data-type="sect2" id="profile-micropost-tests">
<h2><span class="title-label">11.2.3</span> 资料页面中微博的测试</h2>
<p>新激活的用户会重定向到资料页面，那时已经测试了资料页面是否能正确渲染（<a href="chapter10.html#listing-signup-with-account-activation-test">代码清单 10.31</a>）。本节，我们要编写几个简短的集成测试，检查资料页面中的其他内容。首先，生成资料页面的集成测试文件：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate integration_test users_profile
      invoke  test_unit
      create    <span class="nb">test</span>/integration/users_profile_test.rb
</pre></div>
</div>
<p>为了测试资料页面中显示有微博，我们要把微博固件和用户关联起来。Rails 提供了一种便利的方法，可以在固件中建立关联，例如：</p>
<div data-type="listing">


<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span></pre></div>
</div>
<p>把 <code>user</code> 的值设为 <code>michael</code> 后，Rails 会把这篇微博和指定的用户固件关联起来：</p>
<div data-type="listing">


<div class="highlight language-yaml"><pre><span class="hll"><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
</span>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">.</span>
  <span class="l-Scalar-Plain">.</span>
  <span class="l-Scalar-Plain">.</span>
</pre></div>
</div>
<p>为了测试微博分页，我们要使用<a href="chapter9.html#listing-users-fixtures-extra-users">代码清单 9.43</a> 中用到的方法，通过嵌入式 Ruby 代码多生成一些微博固件：</p>
<div data-type="listing">


<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
<span class="l-Scalar-Plain">micropost_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Faker::Lorem.sentence(5) %&gt;</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 42.days.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
<span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</pre></div>
</div>
<p>综上，修改后的微博固件如<a href="#listing-updated-micropost-fixtures">代码清单 11.26</a> 所示。</p>
<div id="listing-updated-micropost-fixtures" data-type="listing">
<h5><span class="title-label">代码清单 11.26</span>：添加关联用户后的微博固件</h5>

<div class="source-file">test/fixtures/microposts.yml</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">tau_manifesto</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Check</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">@tauday</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">@mhartl:</span><span class="nv"> </span><span class="s">http://tauday.com"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.years.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">cat_video</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Sad</span><span class="nv"> </span><span class="s">cats</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">sad:</span><span class="nv"> </span><span class="s">http://youtu.be/PKffm2uI4dk"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.hours.ago %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="l-Scalar-Plain">most_recent</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Writing</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">short</span><span class="nv"> </span><span class="s">test"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span>
<span class="hll"><span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
</span><span class="hll"><span class="l-Scalar-Plain">micropost_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
</span><span class="hll">  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Faker::Lorem.sentence(5) %&gt;</span>
</span><span class="hll">  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 42.days.ago %&gt;</span>
</span><span class="hll">  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</span><span class="hll"><span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</span></pre></div>
</div>
<p>测试数据准备好了，测试本身也很简单：访问资料页面，检查页面的标题、用户的名字、Gravatar 头像、微博数量和分页显示的微博，如<a href="#listing-user-profile-test">代码清单 11.27</a> 所示。注意，为了使用<a href="chapter4.html#listing-title-helper">代码清单 4.2</a> 中的 <code>full_title</code> 辅助方法测试页面的标题，我们要把 <code>ApplicationHelper</code> 模块引入测试。<sup>[<a id="fn-ref-5" href="#fn-5">5</a>]</sup></p>
<div id="listing-user-profile-test" data-type="listing">
<h5><span class="title-label">代码清单 11.27</span>：用户资料页面的测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/users_profile_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersProfileTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
<span class="hll">  <span class="kp">include</span> <span class="no">ApplicationHelper</span>
</span>
  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"profile display"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s1">'title'</span><span class="p">,</span> <span class="n">full_title</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">assert_select</span> <span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_select</span> <span class="s1">'h1&gt;img.gravatar'</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
      <span class="n">assert_match</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>检查微博数量时用到了 <code>response.body</code>，<a href="chapter10.html#account-activation-and-password-reset-exercises">第 10 章的练习</a>中见过。别被名字迷惑了，其实 <code>response.body</code> 的值是整个页面的 HTML 源码（不只是 <code>body</code> 元素中的内容）。如果我们只关心页面中某处显示的微博数量，使用下面的断言找到匹配的内容即可：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</pre></div>
</div>
<p><code>assert_match</code> 没有 <code>assert_select</code> 的针对性强，无需指定要查找哪个 HTML 标签。</p>
<p><a href="#listing-user-profile-test">代码清单 11.27</a> 还在 <code>assert_select</code> 中使用了嵌套式句法：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">assert_select</span> <span class="s1">'h1&gt;img.gravatar'</span>
</pre></div>
</div>
<p>这行代码的意思是，在 <code>h1</code> 标签中查找类为 <code>gravatar</code> 的 <code>img</code> 标签。</p>
<p>因为应用能正常运行，所以测试组件应该也能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.28</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="manipulating-microposts">
<h1><span class="title-label">11.3</span> 微博相关的操作</h1>
<p>微博的数据模型构建好了，也编写了相关的视图文件，接下来我们的开发重点是，通过网页发布微博。本节，我们会初步实现动态流，<a href="chapter12.html#following-users">第 12 章</a>再完善。最后，和用户资源一样，我们还要实现在网页中删除微博的功能。</p>
<p>上述功能的实现和之前的方式有点不同，需要特别注意：微博资源相关的页面不通过微博控制器实现，而是通过资料页面和首页实现。因此微博控制器不需要 <code>new</code> 和 <code>edit</code> 动作，只需要 <code>create</code> 和 <code>destroy</code> 动作。所以，微博资源的路由如<a href="#listing-microposts-resource">代码清单 11.29</a> 所示。 <a href="#listing-microposts-resource">代码清单 11.29</a> 中的代码对应的 REST 路由如<a href="#table-restful-microposts">表 11.2</a> 所示，这张表中的路由只是<a href="chapter2.html#table-demo-restful-microposts">表 2.3</a> 的一部分。不过，路由虽然简化了，但预示着实现的过程需要用到更高级的技术，而不会降低代码的复杂度。从<a href="chapter2.html#a-toy-app">第 2 章</a>起我们就十分依赖脚手架，不过现在我们将舍弃脚手架的大部分功能。</p>
<div id="listing-microposts-resource" data-type="listing">
<h5><span class="title-label">代码清单 11.29</span>：微博资源的路由设置</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div>
</div>
<table id="table-restful-microposts" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 11.2</span>：<a href="#listing-microposts-resource">代码清单 11.29</a> 设置的微博资源路由</caption>
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP 请求</th>
<th class="tableblock halign-left valign-top">URL</th>
<th class="tableblock halign-left valign-top">动作</th>
<th class="tableblock halign-left valign-top">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/microposts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">创建新微博</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/microposts/1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>destroy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">删除 ID 为 1 的微博</p></td>
</tr>
</tbody>
</table>
<section data-type="sect2" id="access-control">
<h2><span class="title-label">11.3.1</span> 访问限制</h2>
<p>开发微博资源的第一步，我们要在微博控制器中实现访问限制：若想访问 <code>create</code> 和 <code>destroy</code> 动作，用户要先登录。</p>
<p>针对这个要求的测试和用户控制器中相应的测试类似（<a href="chapter9.html#listing-edit-update-redirect-tests">代码清单 9.17</a> 和<a href="chapter9.html#listing-action-tests-admin">代码清单 9.56</a>），我们要使用正确的请求类型访问这两个动作，然后确认微博的数量没有变化，而且会重定向到登录页面，如<a href="#listing-create-destroy-micropost-tests">代码清单 11.30</a> 所示。</p>
<div id="listing-create-destroy-micropost-tests" data-type="listing">
<h5><span class="title-label">代码清单 11.30</span>：微博控制器的访问限制测试 <span class="red">RED</span></h5>

<div class="source-file">test/controllers/microposts_controller_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:orange</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect create when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@micropost</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在编写让这个测试通过的应用代码之前，先要做些重构。在 <a href="chapter9.html#requiring-logged-in-users">9.2.1 节</a>，我们定义了一个事前过滤器 <code>logged_in_user</code>（<a href="chapter9.html#listing-authorize-before-filter">代码清单 9.12</a>），要求访问相关的动作之前用户要先登录。那时，我们只需要在用户控制器中使用这个事前过滤器，但是现在也要在微博控制器中使用，所以把它移到 <code>ApplicationController</code> 中（所有控制器的基类），如<a href="#listing-sessions-helper-authenticate">代码清单 11.31</a> 所示。</p>
<div id="listing-sessions-helper-authenticate" data-type="listing">
<h5><span class="title-label">代码清单 11.31</span>：把 <code>logged_in_user</code> 方法移到 <code>ApplicationController</code> 中</h5>

<div class="source-file">app/controllers/application_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>

  <span class="kp">private</span>

    <span class="c1"># 确保用户已登录</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">store_location</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>为了避免代码重复，同时还要把用户控制器中的 <code>logged_in_user</code> 方法删掉。</p>
<p>现在，我们可以在微博控制器中使用 <code>logged_in_user</code> 方法了。我们在微博控制器中添加 <code>create</code> 和 <code>destroy</code> 动作，并使用事前过滤器限制访问，如<a href="#listing-microposts-controller-access-control">代码清单 11.32</a> 所示。</p>
<div id="listing-microposts-controller-access-control" data-type="listing">
<h5><span class="title-label">代码清单 11.32</span>：限制访问微博控制器的动作 <span class="green">GREEN</span></h5>

<div class="source-file">app/controllers/microposts_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在，测试组件应该能通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.33</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
<section data-type="sect2" id="creating-microposts">
<h2><span class="title-label">11.3.2</span> 创建微博</h2>
<p>在<a href="chapter7.html#sign-up">第 7 章</a>，我们实现了用户注册功能，方法是使用 HTML 表单向用户控制器的 <code>create</code> 动作发送 <code>POST</code> 请求。创建微博的功能实现起来类似，主要的不同点是，表单不放在单独的页面 /microposts/new 中，而是在网站的首页（即根地址 /），构思图如<a href="#fig-home-page-with-micropost-form-mockup">图 11.10</a> 所示。</p>
<div id="fig-home-page-with-micropost-form-mockup" class="figure"><img src="images/chapter11/home_page_with_micropost_form_mockup_bootstrap.png" alt="home page with micropost form mockup bootstrap" /><div class="figcaption"><span class="title-label">图 11.10</span>：包含创建微博表单的首页构思图</div></div>
<p>上一次离开首页时，是<a href="chapter5.html#fig-sample-app-logo">图 5.6</a> 那个样子，页面中部有个“Sign up now!”按钮。因为创建微博的表单只对登录后的用户有用，所以本节的目标之一是根据用户的登录状态显示不同的首页内容，如<a href="#listing-microposts-home-page">代码清单 11.35</a> 所示。</p>
<p>我们先来编写微博控制器的 <code>create</code> 动作，和用户控制器的 <code>create</code> 动作类似（<a href="chapter7.html#listing-user-create-action">代码清单 7.23</a>），二者之间主要的区别是，创建微博时，要使用用户和微博的关联关系构建微博对象，如<a href="#listing-microposts-create-action">代码清单 11.34</a> 所示。注意 <code>micropost_params</code> 中的健壮参数，只允许通过 Web 修改微博的 <code>content</code> 属性。</p>
<div id="listing-microposts-create-action" data-type="listing">
<h5><span class="title-label">代码清单 11.34</span>：微博控制器的 <code>create</code> 动作</h5>

<div class="source-file">app/controllers/microposts_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们使用<a href="#listing-microposts-home-page">代码清单 11.35</a> 中的代码编写创建微博所需的表单，这个视图会根据用户的登录状态显示不同的 HTML。</p>
<div id="listing-microposts-home-page" data-type="listing">
<h5><span class="title-label">代码清单 11.35</span>：在首页加入创建微博的表单</h5>

<div class="source-file">app/views/static_pages/home.html.erb</div>

<div class="highlight language-erb"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">  &lt;div class="row"&gt;</span>
</span><span class="hll"><span class="x">    &lt;aside class="col-md-4"&gt;</span>
</span><span class="hll"><span class="x">      &lt;section class="user_info"&gt;</span>
</span><span class="hll"><span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">      &lt;/section&gt;</span>
</span><span class="hll"><span class="x">      &lt;section class="micropost_form"&gt;</span>
</span><span class="hll"><span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="hll"><span class="x">      &lt;/section&gt;</span>
</span><span class="hll"><span class="x">    &lt;/aside&gt;</span>
</span><span class="hll"><span class="x">  &lt;/div&gt;</span>
</span><span class="hll"><span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  &lt;div class="center jumbotron"&gt;</span>
<span class="x">    &lt;h1&gt;Welcome to the Sample App&lt;/h1&gt;</span>

<span class="x">    &lt;h2&gt;</span>
<span class="x">      This is the home page for the</span>
<span class="x">      &lt;a href="http://www.railstutorial.org/"&gt;Ruby on Rails Tutorial&lt;/a&gt;</span>
<span class="x">      sample application.</span>
<span class="x">    &lt;/h2&gt;</span>

<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-lg btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>

<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"Rails logo"</span><span class="p">),</span>
              <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></pre></div>
</div>
<p>（<code>if-else</code> 条件语句中各分支包含的代码太多，有点乱，在<a href="#user-microposts-exercises">练习</a>中会使用局部视图整理。）</p>
<p>为了让<a href="#listing-microposts-home-page">代码清单 11.35</a> 能正常渲染页面，我们要创建几个局部视图。首先是首页的侧边栏，如<a href="#listing-user-info">代码清单 11.36</a> 所示。</p>
<div id="listing-user-info" data-type="listing">
<h5><span class="title-label">代码清单 11.36</span>：用户信息侧边栏局部视图</h5>

<div class="source-file">app/views/shared/_user_info.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="x">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
</pre></div>
</div>
<p>注意，和用户资料页面的侧边栏一样（<a href="#listing-user-show-microposts">代码清单 11.23</a>），<a href="#listing-user-info">代码清单 11.36</a> 中的用户信息也显示了用户发布的微博数量。不过显示上有细微的差别，在用户资料页面的侧边栏中，“Microposts” 是“标注”（label），所以“Microposts (1)”这样的用法是合理的。而在本例中，如果说“1 microposts”的话就不合语法了，所以我们调用了 <code>pluralize</code> 方法（<a href="chapter7.html#signup-error-messages">7.3.3 节</a>见过），显示成“1 micropost”，“2 microposts”等。</p>
<p>下面我们来编写微博创建表单的局部视图，如<a href="#listing-micropost-form">代码清单 11.37</a> 所示。这段代码和<a href="chapter7.html#listing-signup-form">代码清单 7.13</a> 中的注册表单类似。</p>
<div id="listing-micropost-form" data-type="listing">
<h5><span class="title-label">代码清单 11.37</span>：微博创建表单局部视图</h5>

<div class="source-file">app/views/shared/_micropost_form.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div class="field"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>我们还要做两件事，<a href="#listing-micropost-form">代码清单 11.37</a> 中的表单才能使用。第一，（和之前一样）我们要通过关联定义 <code>@micropost</code> 变量：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>
<p>把这行代码写入控制器，如<a href="#listing-micropost-instance-variable">代码清单 11.38</a> 所示。</p>
<div id="listing-micropost-instance-variable" data-type="listing">
<h5><span class="title-label">代码清单 11.38</span>：在 <code>home</code> 动作中定义 <code>@micropost</code> 实例变量</h5>

<div class="source-file">app/controllers/static_pages_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
<span class="hll">    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">logged_in?</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>因为只有用户登录后 <code>current_user</code> 才存在，所以 <code>@micropost</code> 变量只能在用户登录后再定义。</p>
<p>我们要做的第二件事是，重写错误消息局部视图，让<a href="#listing-micropost-form">代码清单 11.37</a> 中的这行能用：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>你可能还记得，在<a href="chapter7.html#listing-f-error-messages">代码清单 7.18</a> 中，错误消息局部视图直接引用了 <code>@user</code> 变量，但现在我们提供的变量是 <code>@micropost</code>。为了在两个地方都能使用这个错误消息局部视图，我们可以把表单变量 <code>f</code> 传入局部视图，通过 <code>f.object</code> 获取相应的对象。因此，在 <code>form_for(@user) do |f|</code> 中，<code>f.object</code> 是 <code>@user</code>；在 <code>form_for(@micropost) do |f|</code> 中，<code>f.object</code> 是 <code>@micropost</code>。</p>
<p>我们要通过一个哈希把对象传入局部视图，值是这个对象，键是局部视图中所需的变量名，如<a href="#listing-micropost-form">代码清单 11.37</a> 中的第二行所示。换句话说，<code>object: f.object</code> 会创建一个名为 <code>object</code> 的变量，供 <code>error_messages</code> 局部视图使用。通过这个对象，我们可以定制错误消息，如<a href="#listing-updated-error-messages-partial">代码清单 11.39</a> 所示。</p>
<div id="listing-updated-error-messages-partial" data-type="listing">
<h5><span class="title-label">代码清单 11.39</span>：能使用其他对象的错误消息局部视图 <span class="red">RED</span></h5>

<div class="source-file">app/views/shared/_error_messages.html.erb</div>

<div class="highlight language-erb"><pre><span class="hll"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  &lt;div id="error_explanation"&gt;</span>
<span class="x">    &lt;div class="alert alert-danger"&gt;</span>
<span class="hll"><span class="x">      The form contains </span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">.</span>
</span><span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="hll"><span class="x">    </span><span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">      &lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="x">&lt;/li&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>现在，你应该确认一下测试组件无法通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.40</span>：<strong class="red">RED</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>这提醒我们要修改其他使用错误消息局部视图的视图，包括用户注册视图（<a href="chapter7.html#listing-f-error-messages">代码清单 7.18</a>），重设密码视图（<a href="chapter10.html#listing-password-reset-form">代码清单 10.50</a>）和编辑用户视图（<a href="chapter9.html#listing-user-edit-view">代码清单 9.2</a>）。这三个视图修改后的版本分别如<a href="#listing-signup-errors-updated">代码清单 11.41</a>，<a href="#listing-password-reset-updated">代码清单 11.43</a> 和<a href="#listing-edit-errors-updated">代码清单 11.42</a> 所示。</p>
<div id="listing-signup-errors-updated" data-type="listing">
<h5><span class="title-label">代码清单 11.41</span>：修改用户注册表单中渲染错误消息局部视图的方式</h5>

<div class="source-file">app/views/users/new.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Sign up&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<div id="listing-edit-errors-updated" data-type="listing">
<h5><span class="title-label">代码清单 11.42</span>：修改编辑用户表单中渲染错误消息局部视图的方式</h5>

<div class="source-file">app/views/users/edit.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Update your profile&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">    &lt;div class="gravatar_edit"&gt;</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;a href="http://gravatar.com/emails"&gt;change&lt;/a&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<div id="listing-password-reset-updated" data-type="listing">
<h5><span class="title-label">代码清单 11.43</span>：修改密码重设表单中渲染错误消息局部视图的方式</h5>

<div class="source-file">app/views/password_resets/edit.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Reset password'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Password reset&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Update password"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>现在，所有测试应该都能通过了：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>而且，本节添加的所有 HTML 代码也都能正确渲染了。<a href="#fig-home-with-form">图 11.11</a> 是创建微博的表单，<a href="#fig-home-form-errors">图 11.12</a> 显示提交表单后有一个错误。</p>
<div id="fig-home-with-form" class="figure"><img src="images/chapter11/home_with_form_3rd_edition.png" alt="home with form 3rd edition" /><div class="figcaption"><span class="title-label">图 11.11</span>：包含创建微博表单的首页</div></div>
<div id="fig-home-form-errors" class="figure"><img src="images/chapter11/home_form_errors_3rd_edition.png" alt="home form errors 3rd edition" /><div class="figcaption"><span class="title-label">图 11.12</span>：表单中显示一个错误消息的首页</div></div>
</section>
<section data-type="sect2" id="a-proto-feed">
<h2><span class="title-label">11.3.3</span> 动态流原型</h2>
<p>现在创建微博的表单可以使用了，但是用户看不到实际效果，因为首页没有显示微博。如果你愿意的话，可以在<a href="#fig-home-with-form">图 11.11</a> 所示的表单中发表一篇有效的微博，然后打开用户资料页面，验证一下这个表单是否可以正常使用。这样在页面之间来来回回有点麻烦，如果能在首页显示一个含有当前登入用户的微博列表（动态流）就好了，构思图如<a href="#fig-proto-feed-mockup">图 11.13</a> 所示。（在<a href="chapter12.html#following-users">第 12 章</a>，我们会在这个微博列表中加入当前登入用户所关注用户发表的微博。）</p>
<div id="fig-proto-feed-mockup" class="figure"><img src="images/chapter11/proto_feed_mockup_3rd_edition.png" alt="proto feed mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 11.13</span>：显示有动态流的首页构思图</div></div>
<p>因为每个用户都有一个动态流，因此我们可以在用户模型中定义一个名为 <code>feed</code> 的方法，查找当前用户发表的所有微博。我们要在微博模型上调用 <code>where</code> 方法（<a href="chapter10.html#account-activation-and-password-reset-exercises">10.5 节</a>提到过）查找微博，如<a href="#listing-proto-status-feed">代码清单 11.44</a> 所示。<sup>[<a id="fn-ref-6" href="#fn-6">6</a>]</sup></p>
<div id="listing-proto-status-feed" data-type="listing">
<h5><span class="title-label">代码清单 11.44</span>：微博动态流的初步实现</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 实现动态流原型</span>
  <span class="c1"># 完整的实现参见第 12 章</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

    <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code>Micropost.where("user_id = ?", id)</code> 中的问号确保 <code>id</code> 的值在传入底层的 SQL 查询语句之前做了适当的转义，避免“<a href="http://en.wikipedia.org/wiki/SQL_injection">SQL 注入</a>”（SQL injection）这种严重的安全隐患。这里用到的 <code>id</code> 属性是个整数，没什么危险，不过在 SQL 语句中引入变量之前做转义是个好习惯。</p>
<p>细心的读者可能已经注意到了，<a href="#listing-proto-status-feed">代码清单 11.44</a> 中的代码和下面的代码是等效的：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们之所以使用<a href="#listing-proto-status-feed">代码清单 11.44</a> 中的版本，是因为它能更好的服务于<a href="chapter12.html#following-users">第 12 章</a>实现的完整动态流。</p>
<p>要在演示应用中添加动态流，我们可以在 <code>home</code> 动作中定义一个 <code>@feed_items</code> 实例变量，分页获取当前用户的微博，如<a href="#listing-feed-instance-variable">代码清单 11.45</a> 所示。然后在首页（参见<a href="#listing-home-with-feed">代码清单 11.47</a>）中加入一个动态流局部视图（参见<a href="#listing-feed-partial">代码清单 11.46</a>）。注意，现在用户登录后要执行两行代码，所以<a href="#listing-feed-instance-variable">代码清单 11.45</a> 把<a href="#listing-micropost-instance-variable">代码清单 11.38</a> 中的</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">logged_in?</span>
</pre></div>
</div>
<p>改成了</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="n">logged_in?</span>
  <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
  <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>也就是把条件放在行尾的代码改成了使用 <code>if-end</code> 语句。</p>
<div id="listing-feed-instance-variable" data-type="listing">
<h5><span class="title-label">代码清单 11.45</span>：在 <code>home</code> 动作中定义一个实例变量，获取动态流</h5>

<div class="source-file">app/controllers/static_pages_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">logged_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
<span class="hll">      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-feed-partial" data-type="listing">
<h5><span class="title-label">代码清单 11.46</span>：动态流局部视图</h5>

<div class="source-file">app/views/shared/_feed.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;ol class="microposts"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/ol&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>动态流局部视图使用如下的代码，把单篇微博交给<a href="#listing-micropost-partial">代码清单 11.21</a> 中的局部视图渲染：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>Rails 知道要渲染 <code>micropost</code> 局部视图，因为 <code>@feed_items</code> 中的元素都是 <code>Micropost</code> 类的实例。所以，Rails 会在对应资源的视图文件夹中寻找正确的局部视图：</p>
<div data-type="listing">


<div class="highlight language-text"><pre>app/views/microposts/_micropost.html.erb
</pre></div>
</div>
<p>和之前一样，我们可以把动态流局部视图加入首页，如<a href="#listing-home-with-feed">代码清单 11.47</a> 所示。加入后的效果就是在首页显示动态流，实现了我们的需求，如<a href="#fig-home-with-proto-feed">图 11.14</a> 所示。</p>
<div id="listing-home-with-feed" data-type="listing">
<h5><span class="title-label">代码清单 11.47</span>：在首页加入动态流</h5>

<div class="source-file">app/views/static_pages/home.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div class="row"&gt;</span>
<span class="x">    &lt;aside class="col-md-4"&gt;</span>
<span class="x">      &lt;section class="user_info"&gt;</span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;/section&gt;</span>
<span class="x">      &lt;section class="micropost_form"&gt;</span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;/section&gt;</span>
<span class="x">    &lt;/aside&gt;</span>
<span class="x">    &lt;div class="col-md-8"&gt;</span>
<span class="x">      &lt;h3&gt;Micropost Feed&lt;/h3&gt;</span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="x">  .</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>现在，发布新微博的功能可以按照设想的方式使用了，如<a href="#fig-micropost-created">图 11.15</a> 所示。不过还有个小小的不足：如果发布微博失败，首页还会需要一个名为 <code>@feed_items</code> 的实例变量，所以提交失败时网站无法正常运行。最简单的解决方法是，如果提交失败就把 <code>@feed_items</code> 设为空数组，如<a href="#listing-microposts-create-action-with-feed">代码清单 11.48</a> 所示。（但是这么做分页链接就失效了，你可以点击分页链接，看一下是什么原因。）</p>
<div id="fig-home-with-proto-feed" class="figure"><img src="images/chapter11/home_with_proto_feed_3rd_edition.png" alt="home with proto feed 3rd edition" /><div class="figcaption"><span class="title-label">图 11.14</span>：显示有动态流原型的首页</div></div>
<div id="fig-micropost-created" class="figure"><img src="images/chapter11/micropost_created_3rd_edition.png" alt="micropost created 3rd edition" /><div class="figcaption"><span class="title-label">图 11.15</span>：发布新微博后的首页</div></div>
<div id="listing-microposts-create-action-with-feed" data-type="listing">
<h5><span class="title-label">代码清单 11.48</span>：在 <code>create</code> 动作中定义 <code>@feed_items</code> 实例变量，值为空数组</h5>

<div class="source-file">app/controllers/microposts_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
<span class="hll">      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
</span>      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section data-type="sect2" id="destroying-microposts">
<h2><span class="title-label">11.3.4</span> 删除微博</h2>
<p>我们要为微博资源实现的最后一个功能是删除。和删除用户类似（<a href="chapter9.html#the-destroy-action">9.4.2 节</a>），删除微博也要通过删除链接实现，构思图如<a href="#fig-micropost-delete-links-mockup">图 11.16</a> 所示。用户只有管理员才能删除，而微博只有发布人才能删除。</p>
<p>首先，我们要在微博局部视图（<a href="#listing-micropost-partial">代码清单 11.21</a>）中加入删除链接，如<a href="#listing-micropost-partial-with-delete">代码清单 11.49</a> 所示。</p>
<div id="listing-micropost-partial-with-delete" data-type="listing">
<h5><span class="title-label">代码清单 11.49</span>：在微博局部视图中添加删除链接</h5>

<div class="source-file">app/views/microposts/_micropost.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;li id="</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;span class="user"&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">  &lt;span class="content"&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">  &lt;span class="timestamp"&gt;</span>
<span class="x">    Posted </span><span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> ago.</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
</span><span class="hll">                                       <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/span&gt;</span>
<span class="x">&lt;/li&gt;</span>
</pre></div>
</div>
<div id="fig-micropost-delete-links-mockup" class="figure"><img src="images/chapter11/micropost_delete_links_mockup_3rd_edition.png" alt="micropost delete links mockup 3rd edition" /><div class="figcaption"><span class="title-label">图 11.16</span>：显示有删除链接的动态流原型构思图</div></div>
<p>然后，参照 <code>UsersController</code> 的 <code>destroy</code> 动作（<a href="chapter9.html#listing-admin-destroy-before-filter">代码清单 9.54</a>），编写 <code>MicropostsController</code> 的 <code>destroy</code> 动作。在 <code>UsersController</code> 中，我们在 <code>admin_user</code> 事前过滤器中定义 <code>@user</code> 变量，查找用户，但现在要通过关联查找微博，这么做，如果某个用户试图删除其他用户的微博，会自动失败。我们把查找微博的操作放在 <code>correct_user</code> 事前过滤器中，确保当前用户确实拥有指定 ID 的微博，如<a href="#listing-microposts-destroy-action">代码清单 11.50</a> 所示。</p>
<div id="listing-microposts-destroy-action" data-type="listing">
<h5><span class="title-label">代码清单 11.50</span>：<code>MicropostsController</code> 的 <code>destroy</code> 动作</h5>

<div class="source-file">app/controllers/microposts_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
</span><span class="hll">    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost deleted"</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="o">||</span> <span class="n">root_url</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
<span class="hll">      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，在 <code>destroy</code> 动作中重定向的地址是：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="o">||</span> <span class="n">root_url</span>
</pre></div>
</div>
<p><code>request.referrer</code> <sup>[<a id="fn-ref-7" href="#fn-7">7</a>]</sup> 和实现友好转向时使用的 <code>request.url</code> 关系紧密，表示前一个 URL（这里是首页）。<sup>[<a id="fn-ref-8" href="#fn-8">8</a>]</sup>因为首页和资料页面都有微博，所以这么做很方便，我们使用 <code>request.referrer</code> 把用户重定向到发起删除请求的页面，如果 <code>request.referrer</code> 为 <code>nil</code>（例如在某些测试中），就转向 <code>root_url</code>。（可以和<a href="chapter8.html#listing-test-helper-log-in">代码清单 8.50</a> 中设置参数默认值的用法对比一下。）</p>
<p>添加上述代码后，删除最新发布的第二篇微博后显示的页面如<a href="#fig-home-post-delete">图 11.17</a> 所示。</p>
<div id="fig-home-post-delete" class="figure"><img src="images/chapter11/home_post_delete_3rd_edition.png" alt="home post delete 3rd edition" /><div class="figcaption"><span class="title-label">图 11.17</span>：删除最新发布的第二篇微博后显示的首页</div></div>
</section>
<section data-type="sect2" id="micropost-tests">
<h2><span class="title-label">11.3.5</span> 微博的测试</h2>
<p>至此，微博模型和相关的界面完成了。我们还要编写简短的微博控制器测试，检查权限限制，以及一个集成测试，检查整个操作流程。</p>
<p>首先，在微博固件中添加一些由不同用户发布的微博，如<a href="#listing-add-micropost-different-owner">代码清单 11.51</a> 所示。（现在只需要使用一个微博固件，但还是要多添加几个，以备后用。）</p>
<div id="listing-add-micropost-different-owner" data-type="listing">
<h5><span class="title-label">代码清单 11.51</span>：添加几个由不同用户发布的微博</h5>

<div class="source-file">test/fixtures/microposts.yml</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">.</span>
<span class="l-Scalar-Plain">ants</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Oh,</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">that</span><span class="nv"> </span><span class="s">what</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">want?</span><span class="nv"> </span><span class="s">Because</span><span class="nv"> </span><span class="s">that's</span><span class="nv"> </span><span class="s">how</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">get</span><span class="nv"> </span><span class="s">ants!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 2.years.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>

<span class="l-Scalar-Plain">zone</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Danger</span><span class="nv"> </span><span class="s">zone!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 3.days.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>

<span class="l-Scalar-Plain">tone</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I'm</span><span class="nv"> </span><span class="s">sorry.</span><span class="nv"> </span><span class="s">Your</span><span class="nv"> </span><span class="s">words</span><span class="nv"> </span><span class="s">made</span><span class="nv"> </span><span class="s">sense,</span><span class="nv"> </span><span class="s">but</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">sarcastic</span><span class="nv"> </span><span class="s">tone</span><span class="nv"> </span><span class="s">did</span><span class="nv"> </span><span class="s">not."</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>

<span class="l-Scalar-Plain">van</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"Dude,</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">van's,</span><span class="nv"> </span><span class="s">like,</span><span class="nv"> </span><span class="s">rolling</span><span class="nv"> </span><span class="s">probable</span><span class="nv"> </span><span class="s">cause."</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 4.hours.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>
</pre></div>
</div>
<p>然后，编写一个简短的测试，确保某个用户不能删除其他用户的微博，并且要重定向到正确的地址，如<a href="#listing-micropost-user-mismatch-test">代码清单 11.52</a> 所示。</p>
<div id="listing-micropost-user-mismatch-test" data-type="listing">
<h5><span class="title-label">代码清单 11.52</span>：测试用户不能删除其他用户的微博 <span class="green">GREEN</span></h5>

<div class="source-file">test/controllers/microposts_controller_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:orange</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect create when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@micropost</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect destroy for wrong micropost"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">))</span>
</span><span class="hll">    <span class="n">micropost</span> <span class="o">=</span> <span class="n">microposts</span><span class="p">(</span><span class="ss">:ants</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
</span><span class="hll">      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>最后，编写一个集成测试：登录，检查有没有分页链接，然后分别提交有效和无效的微博，再删除一篇微博，最后访问另一个用户的资料页面，确保没有删除链接。和之前一样，使用下面的命令生成测试文件：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate integration_test microposts_interface
      invoke  test_unit
      create    <span class="nb">test</span>/integration/microposts_interface_test.rb
</pre></div>
</div>
<p>这个测试的代码如<a href="#listing-microposts-interface-test">代码清单 11.53</a> 所示。看看你能否把代码和前面说的步骤对应起来。（在这个测试中，<code>post</code> 请求后调用了 <code>follow_redirect!</code>，而没有直接使用 <code>post_via_redirect</code>，这是要兼顾<a href="#listing-image-upload-test">代码清单 11.68</a> 中的图片上传测试。）</p>
<div id="listing-microposts-interface-test" data-type="listing">
<h5><span class="title-label">代码清单 11.53</span>：微博资源界面的集成测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/microposts_interface_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"micropost interface"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="c1"># 无效提交</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Micropost.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 有效提交</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">"This micropost really ties the room together"</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="n">content</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_match</span> <span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># 删除一篇微博</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span>
    <span class="n">first_micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="n">first_micropost</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 访问另一个用户的资料页面</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">))</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>因为我们已经把可以正常运行的应用开发好了，所以测试组件应该可以通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 11.54</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="micropost-images">
<h1><span class="title-label">11.4</span> 微博中的图片</h1>
<p>我们已经实现了微博相关的所有操作，本节要让微博除了能输入文字之外还能插入图片。我们首先会开发一个基础版本，只能在生产环境中使用，然后再做一系列功能增强，允许在生产环境上传图片。</p>
<p>添加图片上传功能明显要完成两件事：编写用于上传图片的表单，准备好所需的图片。上传图片按钮和微博中显示的图片构思如<a href="#fig-micropost-image-mockup">图 11.18</a> 所示。<sup>[<a id="fn-ref-9" href="#fn-9">9</a>]</sup></p>
<div id="fig-micropost-image-mockup" class="figure"><img src="images/chapter11/micropost_image_mockup.png" alt="micropost image mockup" /><div class="figcaption"><span class="title-label">图 11.18</span>：图片上传界面的构思图（包含一张上传后的图片）</div></div>
<section data-type="sect2" id="basic-image-upload">
<h2><span class="title-label">11.4.1</span> 基本的图片上传功能</h2>
<p>我们要使用 <a href="https://github.com/carrierwaveuploader/carrierwave">CarrierWave</a> 处理图片上传，并把图片和微博模型关联起来。为此，我们要在 <code>Gemfile</code> 中添加 <code>carrierwave</code> gem，如<a href="#listing-gemfile-carrierwave">代码清单 11.55</a> 所示。为了一次安装完所有 gem，<a href="#listing-gemfile-carrierwave">代码清单 11.55</a> 中还添加了用于调整图片尺寸的 <code>mini_magick</code>（<a href="#image-resizing">11.4.3 节</a>）和用于在生产环境中上传图片的 <code>fog</code>（<a href="#image-upload-in-production">11.4.4 节</a>）。</p>
<div id="listing-gemfile-carrierwave" data-type="listing">
<h5><span class="title-label">代码清单 11.55</span>：在 <code>Gemfile</code> 中添加 CarrierWave</h5>


<div class="highlight language-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.7'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.4.2'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'carrierwave'</span><span class="p">,</span>             <span class="s1">'0.10.0'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'mini_magick'</span><span class="p">,</span>             <span class="s1">'3.8.0'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'fog'</span><span class="p">,</span>                     <span class="s1">'1.36.0'</span>
</span><span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.0.7'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div>
<p>然后像之前一样，执行下面的命令安装：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle install
</pre></div>
</div>
<p>CarrierWave 自带了一个 Rails 生成器，用于生成图片上传程序。我们要创建一个名为 <code>picture</code> 的上传程序：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate uploader Picture
</pre></div>
</div>
<p>CarrierWave 上传的图片应该对应于 Active Record 模型中的一个属性，这个属性只需存储图片的文件名字符串即可。添加这个属性后的微博模型如<a href="#fig-micropost-model-picture">图 11.19</a> 所示。<sup>[<a id="fn-ref-10" href="#fn-10">10</a>]</sup></p>
<div id="fig-micropost-model-picture" class="figure"><img src="images/chapter11/micropost_model_picture.png" alt="micropost model picture" /><div class="figcaption"><span class="title-label">图 11.19</span>：添加 <code>picture</code> 属性后的微博数据模型</div></div>
<p>为了把 <code>picture</code> 属性添加到微博模型中，我们要生成一个迁移，然后在开发服务器中执行迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate migration add_picture_to_microposts picture:string
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>
<p>告诉 CarrierWave 把图片和模型关联起来的方式是使用 <code>mount_uploader</code> 方法。这个方法的第一个参数是属性的符号形式，第二个参数是上传程序的类名：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
</pre></div>
</div>
<p>（<code>PictureUploader</code> 类在 <code>picture_uploader.rb</code> 文件中，<a href="#image-validation">11.4.2 节</a>会编辑，现在使用生成的默认内容即可。）把这个上传程序添加到微博模型，如<a href="#listing-micropost-model-picture">代码清单 11.56</a> 所示。</p>
<div id="listing-micropost-model-picture" data-type="listing">
<h5><span class="title-label">代码清单 11.56</span>：在微博模型中添加图片上传程序</h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
<span class="hll">  <span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
</span>  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在某些系统中可能要重启 Rails 服务器，测试组件才能通过。</p>
<p>如<a href="#fig-micropost-image-mockup">图 11.18</a> 所示，为了在首页添加图片上传功能，我们要在发布微博的表单中添加一个 <code>file_field</code> 标签，如<a href="#listing-micropost-create-image-upload">代码清单 11.57</a> 所示。</p>
<div id="listing-micropost-create-image-upload" data-type="listing">
<h5><span class="title-label">代码清单 11.57</span>：在发布微博的表单中添加图片上传按钮</h5>

<div class="source-file">app/views/shared/_micropost_form.html.erb</div>

<div class="highlight language-erb"><pre><span class="hll"><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">multipart</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div class="field"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;span class="picture"&gt;</span>
<span class="hll"><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  &lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>注意，<code>form_for</code> 中指定了 <code>html: { multipart: true }</code> 参数。为了支持文件上传功能，必须指定这个参数。</p>
<p>最后，我们要把 <code>picture</code> 添加到可通过 Web 修改的属性列表中。为此，要修改 <code>micropost_params</code> 方法，如<a href="#listing-micropost-params-picture">代码清单 11.58</a> 所示。</p>
<div id="listing-micropost-params-picture" data-type="listing">
<h5><span class="title-label">代码清单 11.58</span>：把 <code>picture</code> 添加到允许修改的属性列表中</h5>

<div class="source-file">app/controllers/microposts_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
<span class="hll">      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">,</span> <span class="ss">:picture</span><span class="p">)</span>
</span>    <span class="k">end</span>

     <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>图片上传后，在微博局部视图中可以使用 <code>image_tag</code> 辅助方法渲染，如<a href="#listing-micropost-partial-image-display">代码清单 11.59</a> 所示。注意，我们使用了 <code>picture?</code> 布尔值方法，如果没有图片就不显示 <code>img</code> 标签。这个方法由 CarrierWave 自动创建，方法名根据保存图片文件名的属性而定。自己动手上传图片后显示的页面如<a href="#fig-micropost-with-image">图 11.20</a> 所示。针对图片上传功能的测试留作练习（<a href="#user-microposts-exercises">11.6 节</a>）。</p>
<div id="listing-micropost-partial-image-display" data-type="listing">
<h5><span class="title-label">代码清单 11.59</span>：在微博中显示图片</h5>

<div class="source-file">app/views/microposts/_micropost.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;li id="micropost-</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">),</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;span class="user"&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">  &lt;span class="content"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">micropost</span><span class="o">.</span><span class="n">picture</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">micropost</span><span class="o">.</span><span class="n">picture?</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  &lt;/span&gt;</span>
<span class="x">  &lt;span class="timestamp"&gt;</span>
<span class="x">    Posted </span><span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> ago.</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                       <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/span&gt;</span>
<span class="x">&lt;/li&gt;</span>
</pre></div>
</div>
<div id="fig-micropost-with-image" class="figure"><img src="images/chapter11/microposts_with_image.png" alt="microposts with image" /><div class="figcaption"><span class="title-label">图 11.20</span>：发布包含图片的微博后显示的页面</div></div>
</section>
<section data-type="sect2" id="image-validation">
<h2><span class="title-label">11.4.2</span> 验证图片</h2>
<p>前一节添加的上传程序是个好的开始，但有一定不足：没对上传的文件做任何限制，如果用户上传的文件很大，或者类型不对，会导致问题。这一节我们要修正这个不足，添加验证，限制图片的大小和类型。我们既会在服务器端添加验证，也会在客户端（即浏览器）添加验证。</p>
<p>对图片类型的限制在 CarrierWave 的上传程序中设置。我们要限制能使用的图片扩展名（PNG，GIF 和 JPEG 的两个变种），如<a href="#listing-validate-picture-format">代码清单 11.60</a> 所示。（在生成的上传程序中有一段注释说明了该怎么做。）</p>
<div id="listing-validate-picture-format" data-type="listing">
<h5><span class="title-label">代码清单 11.60</span>：限制可上传图片的类型</h5>

<div class="source-file">app/uploaders/picture_uploader.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">storage</span> <span class="ss">:file</span>

  <span class="c1"># Override the directory where uploaded files will be stored.</span>
  <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># 添加一个白名单，指定允许上传的图片类型</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
<span class="hll">    <span class="sx">%w(jpg jpeg gif png)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>图片大小的限制在微博模型中设定。和前面用过的模型验证不同，Rails 没有为文件大小提供现成的验证方法。所以我们要自己定义一个验证方法，我们把这个方法命名为 <code>picture_size</code>，如<a href="#listing-micropost-model-image-validation">代码清单 11.61</a> 所示。注意，调用自定义的验证时使用的是 <code>validate</code> 方法，而不是 <code>validates</code>。</p>
<div id="listing-micropost-model-image-validation" data-type="listing">
<h5><span class="title-label">代码清单 11.61</span>：添加图片大小验证</h5>

<div class="source-file">app/models/micropost.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">created_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">mount_uploader</span> <span class="ss">:picture</span><span class="p">,</span> <span class="no">PictureUploader</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="hll">  <span class="n">validate</span>  <span class="ss">:picture_size</span>
</span>
  <span class="kp">private</span>

<span class="hll">    <span class="c1"># 验证上传的图片大小</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">picture_size</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">picture</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span>
</span><span class="hll">        <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:picture</span><span class="p">,</span> <span class="s2">"should be less than 5MB"</span><span class="p">)</span>
</span><span class="hll">      <span class="k">end</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>这个验证会调用指定符号（<code>:picture_size</code>）对应的方法。在 <code>picture_size</code> 方法中，如果图片大于 5MB（使用<a href="chapter8.html#aside-time-helpers">旁注 8.2</a> 中介绍的句法），就向 <code>errors</code> 集合（<a href="chapter6.html#validating-presence">6.2.2 节</a>简介过）添加一个自定义的错误消息。</p>
<p>除了这两个验证之外，我们还要在客户端检查上传的图片。首先，我们在 <code>file_field</code> 方法中使用 <code>accept</code> 参数限制图片的格式：</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">accept</span><span class="p">:</span> <span class="s1">'image/jpeg,image/gif,image/png'</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>有效的格式使用 <a href="https://en.wikipedia.org/wiki/Internet_media_type">MIME 类型</a>指定，这些类型对应于<a href="#listing-validate-picture-format">代码清单 11.60</a> 中限制的类型。</p>
<p>然后，我们要编写一些 JavaScript（更确切地说是 <a href="http://jquery.com/">jQuery</a> 代码），如果用户试图上传太大的图片就弹出一个提示框（节省了上传的时间，也减少了服务器的负载）：</p>
<div data-type="listing">


<div class="highlight language-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s1">'#micropost_picture'</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">size_in_megabytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">size</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">size_in_megabytes</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">'Maximum file size is 5MB. Please choose a smaller file.'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>本书虽然没有介绍 jQuery，不过你或许能理解这段代码：监视页面中 CSS ID 为 <code>micropost_picture</code> 的元素（如 <code>#</code> 符号所示，这是微博表单的 ID，参见<a href="#listing-micropost-create-image-upload">代码清单 11.57</a>），当这个元素的内容变化时，会执行这段代码，如果文件太大，就调用 <code>alert</code> 方法。<sup>[<a id="fn-ref-11" href="#fn-11">11</a>]</sup></p>
<p>把这两个检查措施添加到微博表单中，如<a href="#listing-format-jquery-file-test">代码清单 11.62</a> 所示。</p>
<div id="listing-format-jquery-file-test" data-type="listing">
<h5><span class="title-label">代码清单 11.62</span>：使用 jQuery 检查文件的大小</h5>

<div class="source-file">app/views/shared/_micropost_form.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">multipart</span><span class="p">:</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;div class="field"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;span class="picture"&gt;</span>
<span class="hll"><span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">accept</span><span class="p">:</span> <span class="s1">'image/jpeg,image/gif,image/png'</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">  &lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="hll"><span class="x">&lt;script type="text/javascript"&gt;</span>
</span><span class="hll"><span class="x">  $('#micropost_picture').bind('change', function() {</span>
</span><span class="hll"><span class="x">    var size_in_megabytes = this.files[0].size/1024/1024;</span>
</span><span class="hll"><span class="x">    if (size_in_megabytes &gt; 5) {</span>
</span><span class="hll"><span class="x">      alert('Maximum file size is 5MB. Please choose a smaller file.');</span>
</span><span class="hll"><span class="x">    }</span>
</span><span class="hll"><span class="x">  });</span>
</span><span class="hll"><span class="x">&lt;/script&gt;</span>
</span></pre></div>
</div>
<p>有一点很重要，你要知道，像<a href="#listing-format-jquery-file-test">代码清单 11.62</a> 这样的代码并不能阻止用户上传大文件。我们添加的代码虽然能阻止用户通过 Web 界面上传，但用户可以使用 Web 审查工具修改 JavaScript，或者直接发送 <code>POST</code> 请求（例如，使用 <code>curl</code>）。为了阻止用户上传大文件，必须在服务器端添加验证，如<a href="#listing-micropost-model-image-validation">代码清单 11.61</a> 所示。</p>
</section>
<section data-type="sect2" id="image-resizing">
<h2><span class="title-label">11.4.3</span> 调整图片的尺寸</h2>
<p>前一节对图片大小的限制是个好的开始，不过用户还是可以上传尺寸很大的图片，撑破网站的布局，有时会把网站搞得一团糟，如<a href="#fig-large-uploaded-image">图 11.21</a> 所示。因此，如果允许用户从本地硬盘中上传尺寸很大的图片，最好在显示图片之前调整图片的尺寸。<sup>[<a id="fn-ref-12" href="#fn-12">12</a>]</sup></p>
<div id="fig-large-uploaded-image" class="figure"><img src="images/chapter11/large_uploaded_image.png" alt="large uploaded image" /><div class="figcaption"><span class="title-label">图 11.21</span>：上传了一张超级大的图片</div></div>
<p>我们要使用 <a href="http://www.imagemagick.org/">ImageMagick</a> 调整图片的尺寸，所以要在开发环境中安装这个程序。（如 <a href="#image-upload-in-production">11.4.4 节</a>所示，Heroku 已经预先安装好了。）在云端 IDE 中可以使用下面的命令安装：<sup>[<a id="fn-ref-13" href="#fn-13">13</a>]</sup></p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>sudo apt-get update
<span class="nv">$ </span>sudo apt-get install imagemagick --fix-missing
</pre></div>
</div>
<p>然后，我们要在 CarrierWave 中引入 <a href="https://github.com/minimagick/minimagick">MiniMagick</a> 为 ImageMagick 提供的接口，还要调用一个调整尺寸的方法。<a href="http://www.rdoc.info/github/jnicklas/carrierwave/CarrierWave/MiniMagick">MiniMagick 的文档</a>中列出了多个调整尺寸的方法，我们要使用的是 <code>resize_to_limit: [400, 400]</code>，如果图片很大，就把它调整为宽和高都不超过 400 像素，而小于这个尺寸的图片则不调整。（<a href="https://github.com/carrierwaveuploader/carrierwave#using-minimagick">CarrierWave 文档</a>中列出的方法会把小图片放大，这不是我们需要的效果。）添加<a href="#listing-image-uploader-resizing">代码清单 11.63</a> 中的代码后，就能完美调整大尺寸图片了，如<a href="#fig-resized-image">图 11.22</a> 所示。</p>
<div id="listing-image-uploader-resizing" data-type="listing">
<h5><span class="title-label">代码清单 11.63</span>：配置图片上传程序，调整图片的尺寸</h5>

<div class="source-file">app/uploaders/picture_uploader.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>
</span><span class="hll">  <span class="n">process</span> <span class="ss">resize_to_limit</span><span class="p">:</span> <span class="o">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>
</span>
  <span class="n">storage</span> <span class="ss">:file</span>

  <span class="c1"># Override the directory where uploaded files will be stored.</span>
  <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># 添加一个白名单，指定允许上传的图片类型</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
    <span class="sx">%w(jpg jpeg gif png)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="fig-resized-image" class="figure"><img src="images/chapter11/resized_image.png" alt="resized image" /><div class="figcaption"><span class="title-label">图 11.22</span>：调整尺寸后的图片</div></div>
</section>
<section data-type="sect2" id="image-upload-in-production">
<h2><span class="title-label">11.4.4</span> 在生产环境中上传图片</h2>
<p>前面使用的图片上传程序在开发环境中用起来不错，但图片都存储在本地文件系统中（如<a href="#listing-image-uploader-resizing">代码清单 11.63</a> 中 <code>storage :file</code> 那行所示），在生产环境这么做可不好。<sup>[<a id="fn-ref-14" href="#fn-14">14</a>]</sup>所以，我们要使用云存储服务存储图片，和应用所在的文件系统分开。<sup>[<a id="fn-ref-15" href="#fn-15">15</a>]</sup></p>
<p>我们要使用 <code>fog</code> gem 配置应用，在生产环境使用云存储，如<a href="#listing-image-uploader-production">代码清单 11.64</a> 所示。</p>
<div id="listing-image-uploader-production" data-type="listing">
<h5><span class="title-label">代码清单 11.64</span>：配置生产环境使用的图片上传程序</h5>

<div class="source-file">app/uploaders/picture_uploader.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>
  <span class="n">process</span> <span class="ss">resize_to_limit</span><span class="p">:</span> <span class="o">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="o">]</span>

<span class="hll">  <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
</span><span class="hll">    <span class="n">storage</span> <span class="ss">:fog</span>
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">    <span class="n">storage</span> <span class="ss">:file</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="c1"># Override the directory where uploaded files will be stored.</span>
  <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:</span>
  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="c1"># 添加一个白名单，指定允许上传的图片类型</span>
  <span class="k">def</span> <span class="nf">extension_white_list</span>
    <span class="sx">%w(jpg jpeg gif png)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在<a href="#listing-image-uploader-production">代码清单 11.64</a> 中，使用<a href="chapter7.html#aside-rails-environments">旁注 7.1</a> 中介绍的 <code>production?</code> 布尔值方法根据所在的环境选择存储方式：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
  <span class="n">storage</span> <span class="ss">:fog</span>
<span class="k">else</span>
  <span class="n">storage</span> <span class="ss">:file</span>
<span class="k">end</span>
</pre></div>
</div>
<p>云存储服务有很多，我们要使用其中一个最受欢迎并且支持比较好的——Amazon 的 <a href="http://aws.amazon.com/s3/">Simple Storage Service</a>（简称 S3）。<sup>[<a id="fn-ref-16" href="#fn-16">16</a>]</sup>基本步骤如下：</p>
<ol class="arabic">
<li>
<p>注册一个 <a href="http://aws.amazon.com/">Amazon Web Services</a> 账户；</p>
</li>
<li>
<p>通过 <a href="http://aws.amazon.com/iam/">AWS Identity and Access Management</a>（简称 IAM） 创建一个用户，记下访问公钥和密钥；</p>
</li>
<li>
<p>使用 <a href="https://console.aws.amazon.com/s3">AWS Console</a> 创建一个 S3 bucket（名字自己定），然后赋予上一步创建的用户读写权限。</p>
</li>
</ol>
<p>关于这些步骤的详细说明，参见 <a href="http://aws.amazon.com/documentation/s3/">S3 的文档</a>。（如果需要还可以搜索。）</p>
<p>创建并配置好 S3 账户后，创建 CarrierWave 配置文件，写入<a href="#listing-carrier-wave-configuration">代码清单 11.65</a> 中的内容。注意：如果做了这些设置之后连不上 S3，可能是区域位置的问题。有些用户要在 fog 的配置中添加 <code>:region =&gt; ENV['S3_REGION']</code>，然后在命令行中执行 <code>heroku config:set S3_REGION=&lt;bucket_region&gt;</code>，其中 <code>bucket_region</code> 是你所在的区域，例如 <code>'eu-central-1'</code>。如果想找到你所在的区域，请查看 <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">Amazon AWS 的文档</a>。</p>
<div id="listing-carrier-wave-configuration" data-type="listing">
<h5><span class="title-label">代码清单 11.65</span>：配置 CarrierWave 使用 S3</h5>

<div class="source-file">config/initializers/carrier_wave.rb</div>

<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
  <span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1"># Amazon S3 的配置</span>
      <span class="ss">:provider</span>              <span class="o">=&gt;</span> <span class="s1">'AWS'</span><span class="p">,</span>
      <span class="ss">:aws_access_key_id</span>     <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_ACCESS_KEY'</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:aws_secret_access_key</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_SECRET_KEY'</span><span class="o">]</span>
    <span class="p">}</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>     <span class="o">=</span>  <span class="no">ENV</span><span class="o">[</span><span class="s1">'S3_BUCKET'</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>和生产环境的电子邮件配置一样（<a href="chapter10.html#listing-sendgrid-config">代码清单 10.56</a>），<a href="#listing-carrier-wave-configuration">代码清单 11.65</a> 也使用 Heroku 中的 <code>ENV</code> 变量，没直接在代码中写入敏感信息。在 <a href="chapter10.html#email-in-production">10.3 节</a>，电子邮件所需的变量由 SendGrid 扩展自动定义，但现在我们要自己定义，方法是使用 <code>heroku config:set</code> 命令，如下所示：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>heroku config:set <span class="nv">S3_ACCESS_KEY</span><span class="o">=</span>&lt;access key&gt;
<span class="nv">$ </span>heroku config:set <span class="nv">S3_SECRET_KEY</span><span class="o">=</span>&lt;secret key&gt;
<span class="nv">$ </span>heroku config:set <span class="nv">S3_BUCKET</span><span class="o">=</span>&lt;bucket name&gt;
</pre></div>
</div>
<p>配置好之后，我们可以提交并部署了。我们先提交主题分支中的变动，然后再合并到 <code>master</code> 分支：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="nv">$ </span>git add -A
<span class="nv">$ </span>git commit -m <span class="s2">"Add user microposts"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge user-microposts
<span class="nv">$ </span>git push
</pre></div>
</div>
<p>然后部署，重设数据库，再重新把示例数据载入数据库：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>git push heroku
<span class="nv">$ </span>heroku pg:reset DATABASE
<span class="nv">$ </span>heroku run rake db:migrate
<span class="nv">$ </span>heroku run rake db:seed
</pre></div>
</div>
<p>Heroku 已经安装了 ImageMagick，所在生产环境中调整图片尺寸和上传功能都能正常使用，如<a href="#fig-image-upload-production">图 11.23</a> 所示。</p>
<div id="fig-image-upload-production" class="figure"><img src="images/chapter11/image_upload_production.png" alt="image upload production" /><div class="figcaption"><span class="title-label">图 11.23</span>：在生产环境中上传图片</div></div>
</section>
</section>
<section data-type="sect1" id="user-microposts-conclusion">
<h1><span class="title-label">11.5</span> 小结</h1>
<p>实现微博资源后，我们的演示应用基本上完成了。现在还剩下社交功能没有实现，即让用户之间可以相互关注。在<a href="chapter12.html#following-users">第 12 章</a>，我们会学习如何实现用户之间的这种关系，还要实现一个真正的动态流。</p>
<p>如果你跳过了 <a href="#image-upload-in-production">11.4.4 节</a>，在继续之前，先提交改动，然后再合并到 <code>master</code> 分支：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="nv">$ </span>git add -A
<span class="nv">$ </span>git commit -m <span class="s2">"Add user microposts"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge user-microposts
<span class="nv">$ </span>git push
</pre></div>
</div>
<p>然后部署到生产环境：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>git push heroku
<span class="nv">$ </span>heroku pg:reset DATABASE
<span class="nv">$ </span>heroku run rake db:migrate
<span class="nv">$ </span>heroku run rake db:seed
</pre></div>
</div>
<p>值得注意的是，这一章安装了需要的最后几个 gem。为了便于参考，完整的 <code>Gemfile</code> 如<a href="#listing-final-gemfile">代码清单 11.66</a> 所示。</p>
<div id="listing-final-gemfile" data-type="listing">
<h5><span class="title-label">代码清单 11.66</span>：演示应用的 <code>Gemfile</code> 完整版本</h5>


<div class="highlight language-ruby"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'4.2.2'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.7'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.4.2'</span>
<span class="n">gem</span> <span class="s1">'carrierwave'</span><span class="p">,</span>             <span class="s1">'0.10.0'</span>
<span class="n">gem</span> <span class="s1">'mini_magick'</span><span class="p">,</span>             <span class="s1">'3.8.0'</span>
<span class="n">gem</span> <span class="s1">'fog'</span><span class="p">,</span>                     <span class="s1">'1.23.0'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.0.7'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span>          <span class="s1">'3.2.0.0'</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>              <span class="s1">'5.0.2'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>                <span class="s1">'2.5.3'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span>            <span class="s1">'4.1.0'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span>            <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span>              <span class="s1">'2.3.0'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span>                <span class="s1">'2.2.3'</span>
<span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span>                    <span class="s1">'0.4.0'</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:doc</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span>     <span class="s1">'1.3.9'</span>
  <span class="n">gem</span> <span class="s1">'byebug'</span><span class="p">,</span>      <span class="s1">'3.4.0'</span>
  <span class="n">gem</span> <span class="s1">'web-console'</span><span class="p">,</span> <span class="s1">'2.0.0.beta3'</span>
  <span class="n">gem</span> <span class="s1">'spring'</span><span class="p">,</span>      <span class="s1">'1.1.3'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'minitest-reporters'</span><span class="p">,</span> <span class="s1">'1.0.5'</span>
  <span class="n">gem</span> <span class="s1">'mini_backtrace'</span><span class="p">,</span>     <span class="s1">'0.1.3'</span>
  <span class="n">gem</span> <span class="s1">'guard-minitest'</span><span class="p">,</span>     <span class="s1">'2.3.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span>             <span class="s1">'0.17.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
  <span class="n">gem</span> <span class="s1">'unicorn'</span><span class="p">,</span>        <span class="s1">'4.8.3'</span>
<span class="k">end</span>
</pre></div>
</div>
<section data-type="sect2" id="user-microposts-learned">
<h2><span class="title-label">11.5.1</span> 读完本章学到了什么</h2>
<ul>
<li>
<p>和用户一样，微博也是一种“资源”，而且有对应的 Active Record 模型；</p>
</li>
<li>
<p>Rails 支持多键索引；</p>
</li>
<li>
<p>我们可以分别在用户和微博模型中使用 <code>has_many</code> 和 <code>belongs_to</code> 方法实现一个用户拥有多篇微博的模型；</p>
</li>
<li>
<p><code>has_many</code>/<code>belongs_to</code> 会创建很多方法，通过关联创建对象；</p>
</li>
<li>
<p><code>user.microposts.build(…​)</code> 创建一个微博对象，并自动把这个微博和用户关联起来；</p>
</li>
<li>
<p>Rails 支持使用 <code>default_scope</code> 指定默认排序方式；</p>
</li>
<li>
<p>作用域方法的参数是匿名函数；</p>
</li>
<li>
<p>加入 <code>dependent: :destroy</code> 参数后，删除对象时也会把关联的对象删除；</p>
</li>
<li>
<p>分页和数量统计都可以通过关联调用，这样写出的代码很简洁；</p>
</li>
<li>
<p>在固件中可以创建关联；</p>
</li>
<li>
<p>可以向 Rails 局部视图中传入变量；</p>
</li>
<li>
<p>查询 Active Record 模型时可以使用 <code>where</code> 方法；</p>
</li>
<li>
<p>通过关联创建和销毁对象有安全保障；</p>
</li>
<li>
<p>可以使用 CarrierWave 上传图片及调整图片的尺寸。</p>
</li>
</ul>
</section>
</section>
<section data-type="sect1" id="user-microposts-exercises">
<h1><span class="title-label">11.6</span> 练习</h1>
<p>避免练习和正文冲突的方法参见<a href="chapter3.html#mostly-static-pages-exercises">第 3 章练习</a>中的说明。</p>
<ol class="arabic">
<li>
<p>重构首页视图，把 <code>if-else</code> 语句的两个分支分别放到单独的局部视图中。</p>
</li>
<li>
<p>为侧边栏中的微博数量编写测试（还要检查使用了正确的单复数形式）。可以参照<a href="#listing-sidebar-micropost-count">代码清单 11.67</a>。</p>
</li>
<li>
<p>以<a href="#listing-image-upload-test">代码清单 11.68</a> 为模板，为 <a href="#micropost-images">11.4 节</a>的图片上传程序编写测试。测试之前，要在固件文件夹中放一个图片（例如，可以执行 <code>cp app/assets/images/rails.png test/fixtures/</code> 命令）。（如果使用 Git，建议你更新 <code>.gitignore</code> 文件，如<a href="#listing-gitignore-uploads">代码清单 11.69</a> 所示。）为了避免出现难以理解的错误，还要配置 CarrierWave，在测试中不调整图片的尺寸。方法是创建一个初始化脚本，写入<a href="#listing-skip-resize-initializer">代码清单 11.70</a> 中的内容。<a href="#listing-image-upload-test">代码清单 11.68</a> 中添加的几个断言，检查首页有没有文件上传字段，以及成功提交表单后有没有正确设定 <code>picture</code> 属性的值。注意，在测试中上传固件中的文件使用的是专门的 <code>fixture_file_upload</code> 方法。<sup>[<a id="fn-ref-17" href="#fn-17">17</a>]</sup>提示：为了检查 <code>picture</code> 属性的值，可以使用 <a href="chapter10.html#activation-test-and-refactoring">10.1.4 节</a>介绍的 <code>assigns</code> 方法，在提交成功后获取 <code>create</code> 动作中的 <code>@micropost</code> 变量。</p>
</li>
</ol>
<div id="listing-sidebar-micropost-count" data-type="listing">
<h5><span class="title-label">代码清单 11.67</span>：侧边栏中微博数量的测试模板</h5>

<div class="source-file">test/integration/microposts_interface_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"micropost sidebar count"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="s2">"</span><span class="si">#{</span><span class="no">FILL_IN</span><span class="si">}</span><span class="s2"> microposts"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># 这个用户没有发布微博</span>
    <span class="n">other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:malory</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="s2">"0 microposts"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">other_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"A micropost"</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_match</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-image-upload-test" data-type="listing">
<h5><span class="title-label">代码清单 11.68</span>：图片上传测试的模板</h5>

<div class="source-file">test/integration/microposts_interface_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">MicropostInterfaceTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"micropost interface"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
<span class="hll">    <span class="n">assert_select</span> <span class="s1">'input[type=FILL_IN]'</span>
</span>    <span class="c1"># 无效提交</span>
    <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 有效提交</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">"This micropost really ties the room together"</span>
<span class="hll">    <span class="n">picture</span> <span class="o">=</span> <span class="n">fixture_file_upload</span><span class="p">(</span><span class="s1">'test/fixtures/rails.png'</span><span class="p">,</span> <span class="s1">'image/png'</span><span class="p">)</span>
</span>    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
<span class="hll">      <span class="n">post</span> <span class="n">microposts_path</span><span class="p">,</span> <span class="ss">micropost</span><span class="p">:</span> <span class="p">{</span> <span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="ss">picture</span><span class="p">:</span> <span class="no">FILL_IN</span> <span class="p">}</span>
</span>    <span class="k">end</span>
<span class="hll">    <span class="n">assert</span> <span class="no">FILL_IN</span><span class="o">.</span><span class="n">picture?</span>
</span>    <span class="n">follow_redirect!</span>
    <span class="n">assert_match</span> <span class="n">content</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="c1"># 删除一篇微博</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'delete'</span>
    <span class="n">first_micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">assert_difference</span> <span class="s1">'Micropost.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="n">first_micropost</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># 访问另一个用户的资料页面</span>
    <span class="n">get</span> <span class="n">user_path</span><span class="p">(</span><span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">))</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="p">{</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-gitignore-uploads" data-type="listing">
<h5><span class="title-label">代码清单 11.69</span>：在 <code>.gitignore</code> 中添加存储上传图片的文件夹</h5>


<div class="highlight language-text"><pre># See https://help.github.com/articles/ignoring-files for more about ignoring
# files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore Spring files.
/spring/*.pid

<span class="hll"># Ignore uploaded test images.
</span><span class="hll">/public/uploads
</span></pre></div>
</div>
<div id="listing-skip-resize-initializer" data-type="listing">
<h5><span class="title-label">代码清单 11.70</span>：一个初始化脚本，在测试中不调整图片的尺寸</h5>

<div class="source-file">config/initializers/skip_image_resizing.rb</div>

<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
  <span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">enable_processing</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
</section>
                </article>

                <div class="navi clearfix">
                    
                        <div class="pull-left">
                            <a class="prev" href="chapter10.html" title="第 10 章 账户激活和密码重设">&laquo; 第 10 章 账户激活和密码重设</a>
                        </div>
                    
                    
                        <div class="pull-right">
                            <a class="next" href="chapter12.html" title="第 12 章 关注用户">第 12 章 关注用户 &raquo; </a>
                        </div>
                    
                </div>

                <div class="footnotes">
<ol>
<li id="fn-1"><a href="chapter9.html#updating-showing-and-deleting-users-conclusion">9.5 节</a>列出所有用户时也遇到了同样的问题。 <a href="#fn-ref-1" class="symbol">&#8617;</a></li>
<li id="fn-2"><code>Faker::Lorem.sentence</code> 生成 lorem ipsum 文本。<a href="chapter6.html#modeling-users">第 6 章</a>说过，lorem ipsum 的<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">背景故事很有趣</a>。 <a href="#fn-ref-2" class="symbol">&#8617;</a></li>
<li id="fn-3">Faker 生成的 lorem ipsum 文本是随机的，所以你看到的示例微博可能和我的不一样。 <a href="#fn-ref-3" class="symbol">&#8617;</a></li>
<li id="fn-4">为了方便，<a href="#listing-micropost-css">代码清单 11.25</a> 实际上包含了本章用到的所有 CSS。 <a href="#fn-ref-4" class="symbol">&#8617;</a></li>
<li id="fn-5">如果想使用 <code>full_title</code> 重构其他测试，例如<a href="chapter3.html#listing-base-title-test">代码清单 3.38</a>，应该在 <code>test_helper.rb</code> 中引入 <code>ApplicationHelper</code> 模块。 <a href="#fn-ref-5" class="symbol">&#8617;</a></li>
<li id="fn-6"><code>where</code> 及其他相关方法的详细介绍参见 Rails Guides 中《<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a>》一文。 <a href="#fn-ref-6" class="symbol">&#8617;</a></li>
<li id="fn-7">对应 HTTP 规范中的 <code>HTTP_REFERER</code>。注意，“REFERER”不是错误拼写，规范中就是这么写的。Rails 更正了这个错误，写成“referrer”。 <a href="#fn-ref-7" class="symbol">&#8617;</a></li>
<li id="fn-8">我没有立即想到如何在 Rails 应用中获取这个 URL，所以在谷歌中搜索“rails request previous url”，找到了 <a href="http://stackoverflow.com/questions/4652084/ruby-on-rails-how-do-you-get-the-previous-url">Stack Overflow 中的这个问答</a>。 <a href="#fn-ref-8" class="symbol">&#8617;</a></li>
<li id="fn-9">沙滩的图片来源：https://www.flickr.com/photos/grungepunk/14026922186。 <a href="#fn-ref-9" class="symbol">&#8617;</a></li>
<li id="fn-10">一开始我把这个属性命名为 <code>image</code>，但这个名字太泛泛了，容易误解。 <a href="#fn-ref-10" class="symbol">&#8617;</a></li>
<li id="fn-11">如果想知道怎么实现这样的效果，可以在谷歌中搜索“javascript maximum file size”，你会在 Stack Overflow 中找到答案的。 <a href="#fn-ref-11" class="symbol">&#8617;</a></li>
<li id="fn-12">使用 CSS 也能限制图片显示的尺寸，但无法改变图片本身的尺寸。一般来说，尺寸大的图片加载时间要久一些。（你可能访问过一些网站，图片虽然“小”，但是加载时间很长。就是这个原因。） <a href="#fn-ref-12" class="symbol">&#8617;</a></li>
<li id="fn-13"><a href="https://help.ubuntu.com/community/ImageMagick">Ubuntu 文档</a>中有说明。如果你没使用云端 IDE，或其他类似的 Linux 系统，可以在谷歌中搜索“imagemagick &lt;your platform&gt;”。在 OS X 中，如果安装了 <a href="http://brew.sh/">Homebrew</a>，可以执行 <code>brew install imagemagick</code> 命令安装。 <a href="#fn-ref-13" class="symbol">&#8617;</a></li>
<li id="fn-14">坏处有很多，其中一个是：Heroku 中存储的文件是临时的，重新部署后会把以前上传的图片删除。 <a href="#fn-ref-14" class="symbol">&#8617;</a></li>
<li id="fn-15">这一节有一定难度，可以跳过，对后面的内容不会有影响。 <a href="#fn-ref-15" class="symbol">&#8617;</a></li>
<li id="fn-16">S3 是收费服务，不过测试这个演示应用，每月的花费不会超过一美分。 <a href="#fn-ref-16" class="symbol">&#8617;</a></li>
<li id="fn-17">如果使用 Windows 系统，要加上 <code>:binary</code> 参数：<code>fixture_file_upload(file, type, :binary)</code>。 <a href="#fn-ref-17" class="symbol">&#8617;</a></li>
</ol>
</div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <p>&copy;2013-2015 <a href="http://about.ac" title="安道的网站">安道</a></p>
    <p class="sns"><a href="https://twitter.com/andor_chen" title="安道的 Twitter"><i class="fa fa-twitter"></i></a> <a href="http://weibo.com/andor27" title="安道的微博"><i class="fa fa-weibo"></i></a></p>
    <p>保留部分权利，禁止转载</p>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56255794-2', 'auto');
  ga('send', 'pageview');
  $('#navbar-purchase').on('click',function(){
    ga('send', 'event', 'button', 'click', 'navbar purchase');
  });
  $('#navbar-purchase-xs').on('click',function(){
    ga('send', 'event', 'button', 'click', 'navbar purchase xs');
  });
</script>

</body>
</html>
