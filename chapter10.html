<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>Ruby on Rails 教程 - 第 10 章 账户激活和密码重设</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="最好的 Ruby on Rails 入门教程"/>
    <meta name="keywords" content="ruby, rails, tutorial"/>
    <meta name="author" content="Michael Hartl"/>
    <meta name="translator" content="安道"/>
    <meta name="generator" content="persie 0.0.1.beta.3"/>
    <link rel="stylesheet" type="text/css" href="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/style.css"/>
    <script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/twitter-bootstrap/3.2.0/js/collapse.min.js"></script>
    <script type="text/javascript" src="assets/global.js"></script>
</head>
<body>

<header class="navbar navbar-default navbar-fixed-top navbar-book">
    <div class="container">
        <div class="navbar-header">
            <a href="http://railstutorial-china.org" class="navbar-brand">Ruby on Rails 教程</a>
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".book-navbar-collapse">
                <span class="sr-only">导航</span>
                <i class="fa fa-bars"></i>
            </button>
            <a href="http://railstutorial-china.org/#purchase" id="navbar-purchase-xs" class="btn btn-warning navbar-btn visible-xs collapsed-purchase-btn">购买</a>
        </div>
        <nav class="collapse navbar-collapse book-navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://railstutorial-china.org" title="首页">首页</a></li>
                <li class="active"><a href="http://railstutorial-china.org/read/" title="在线阅读">阅读</a></li>
                <li><a href="http://railstutorial-china.org/blog/" title="最新消息">博客</a></li>
                <li><a href="https://selfstore.io/products/189/topics" title="论坛">论坛</a></li>
                <li class="hidden-xs"><div><a href="http://railstutorial-china.org/#purchase" id="navbar-purchase" class="btn btn-warning navbar-btn" title="购买电子书">购买</a></div></li>
            </ul>
        </nav>
    </div>
</header>

<div class="content">
    <div class="container">
        <div class="row">
            <div class="col-lg-offset-2 col-lg-8">
                <div class="alert alert-warning">
                    <p>在线版的内容可能落后于电子书，如果想及时获得更新，请<a href="http://railstutorial-china.org/#purchase" title="购买电子书">购买电子书</a>。</p>
                </div>
                <article class="article">
                    <section data-type="chapter" id="account-activation-and-password-reset">
<h1><span class="title-label">第 10 章</span> 账户激活和密码重设</h1>
<p><a href="chapter9.html#updating-showing-and-deleting-users">第 9 章</a>完成了一个基本的用户资源（实现了<a href="chapter7.html#table-restful-users">表 7.1</a> 中的所有 REST 标准动作），以及灵活的认证和权限系统。本章，我们要对这个系统做最后的调整，增加两个联系紧密的功能：账户激活（验证新注册用户的电子邮件地址）和密码重设（帮助忘记密码的用户）。实现这两个功能都要创建新资源，借此机会我们还能再介绍一下控制器、路由和数据库迁移。这两个功能还涉及到一个重要且具挑战的话题——在 Rails 应用中发送电子邮件。而且这两个功能之间需要相互配合，因为重设密码时要向用户的电子邮件地址发送一封包含重设链接的邮件，电子邮件地址是否有效则要在激活账户时验证。<sup>[<a id="fn-ref-1" href="#fn-1">1</a>]</sup></p>
<section data-type="sect1" id="account-activation">
<h1><span class="title-label">10.1</span> 账户激活</h1>
<p>目前，用户注册后立即就能完全控制自己的账户（<a href="chapter7.html#sign-up">第 7 章</a>）。本节，我们要添加一步，激活用户的账户，从而确认用户拥有注册时使用的电子邮件地址。为此，我们要为用户创建激活令牌和摘要，然后给用户发送一封电子邮件，提供包含令牌的链接。用户点击这个链接后，激活这个账户。</p>
<p>我们要采取的实现步骤与注册用户（<a href="chapter8.html#logging-in">8.2 节</a>）和记住用户（<a href="chapter8.html#remember-me">8.4 节</a>）差不多，如下所示：</p>
<ol class="arabic">
<li>
<p>用户一开始处于“未激活”状态；</p>
</li>
<li>
<p>用户注册后，生成一个激活令牌和对应的激活摘要；</p>
</li>
<li>
<p>把激活摘要存储在数据库中，然后给用户发送一封电子邮件，提供一个包含激活令牌和用户电子邮件地址的链接；<sup>[<a id="fn-ref-2" href="#fn-2">2</a>]</sup></p>
</li>
<li>
<p>用户点击这个链接后，使用电子邮件地址查找用户，并且对比令牌和摘要；</p>
</li>
<li>
<p>如果令牌和摘要匹配，就把状态由“未激活”改为“已激活”。</p>
</li>
</ol>
<p>因为与密码和记忆令牌类似，实现账户激活（以及密码重设）功能时可以继续使用前面的很多方法，包括 <code>User.digest</code>、<code>User.new_token</code> 和修改过的 <code>user.authenticated?</code>。这几个功能（包括 <a href="#password-reset">10.2 节</a>要实现的密码重设）之间的对比，如<a href="#table-password-token-digest">表 10.1</a> 所示。我们会在 <a href="#activating-the-account">10.1.3 节</a>定义可用于表中所有情况的通用版 <code>authenticated?</code> 方法。</p>
<table id="table-password-token-digest" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 10.1</span>：登录，记住状态，账户激活和密码重设之间的对比</caption>
<colgroup>
<col style="width: 15%;" />
<col style="width: 20%;" />
<col style="width: 25%;" />
<col style="width: 40%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">查找方式</th>
<th class="tableblock halign-left valign-top">字符串</th>
<th class="tableblock halign-left valign-top">摘要</th>
<th class="tableblock halign-left valign-top">认证</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>email</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password_digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authenticate(password)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>remember_token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>remember_digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authenticated?(:remember, token)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>email</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>activation_token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>activation_digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authenticated?(:activation, token)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>email</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset_token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset_digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authenticated?(:reset, token)</code></p></td>
</tr>
</tbody>
</table>
<p>和之前一样，我们要在主题分支中开发新功能。读到 <a href="#email-in-production">10.3 节</a>会发现，账户激活和密码重设需要共用一些电子邮件设置，合并到 <code>master</code> 分支之前，要把这些设置应用到这两个功能上，所以在一个分支中开发这两个功能比较方便：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git checkout -b account-activation-password-resets
</pre></div>
</div>
<section data-type="sect2" id="account-activations-resource">
<h2><span class="title-label">10.1.1</span> 资源</h2>
<p>和会话一样（<a href="chapter8.html#sessions">8.1 节</a>），我们要把“账户激活”看做一个资源，不过这个资源不对应模型，相关的数据（激活令牌和激活状态）存储在用户模型中。然而，我们要通过标准的 REST URL 处理账户激活操作。激活链接会改变用户的激活状态，所以我们计划在 <code>edit</code> 动作中处理。<sup>[<a id="fn-ref-3" href="#fn-3">3</a>]</sup>所需的控制器使用下面的命令生成：<sup>[<a id="fn-ref-4" href="#fn-4">4</a>]</sup></p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate controller AccountActivations --no-test-framework
</pre></div>
</div>
<p>我们需要使用下面的方法生成一个 URL，放在激活邮件中：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>
<p>因此，我们需要为 <code>edit</code> 动作设定一个具名路由——通过<a href="#listing-account-activations-route">代码清单 10.1</a> 中高亮显示的那行 <code>resources</code> 实现。</p>
<div id="listing-account-activations-route" data-type="listing">
<h5><span class="title-label">代码清单 10.1</span>：添加账户激活所需的资源路由</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>接下来，我们需要一个唯一的激活令牌，用来激活用户。密码、记忆令牌和密码重设（<a href="#password-reset">10.2 节</a>）需要考虑很多安全隐患，因为如果攻击者获取了这些信息就能完全控制账户。账户激活则不需要这么麻烦，但如果不哈希激活令牌，账户也有一定危险。<sup>[<a id="fn-ref-5" href="#fn-5">5</a>]</sup>所以，参照记住登录状态的做法（<a href="chapter8.html#remember-me">8.4 节</a>），我们会公开令牌，而在数据库中存储哈希摘要。这么做，我们可以使用下面的方式获取激活令牌：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span>
</pre></div>
</div>
<p>使用下面的代码认证用户：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</pre></div>
</div>
<p>（不过得先修改<a href="chapter8.html#listing-authenticated-p">代码清单 8.33</a> 中定义的 <code>authenticated?</code> 方法。）我们还要定义一个布尔值属性 <code>activated</code>，使用自动生成的布尔值方法检查用户的激活状态（类似 <a href="chapter9.html#administrative-users">9.4.1 节</a>使用的方法）：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>
<p>最后，我们还要记录激活的日期和时间，虽然本书用不到，但说不定以后需要使用。完整的数据模型如<a href="#fig-user-model-account-activation">图 10.1</a> 所示。</p>
<div id="fig-user-model-account-activation" class="figure"><img src="images/chapter10/user_model_account_activation.png" alt="user model account activation" /><div class="figcaption"><span class="title-label">图 10.1</span>：添加账户激活相关属性后的用户模型</div></div>
<p>下面的命令生成一个迁移，添加这些属性。我们在命令行中指定了要添加的三个属性：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate migration add_activation_to_users <span class="se">\</span>
&gt; activation_digest:string activated:boolean activated_at:datetime
</pre></div>
</div>
<p>和 <code>admin</code> 属性一样（<a href="chapter9.html#listing-admin-migration">代码清单 9.50</a>），我们要把 <code>activated</code> 属性的默认值设为 <code>false</code>，如<a href="#listing-add-activation-to-users-migration">代码清单 10.2</a> 所示。</p>
<div id="listing-add-activation-to-users-migration" data-type="listing">
<h5><span class="title-label">代码清单 10.2</span>：添加账户激活所需属性的迁移</h5>

<div class="source-file">db/migrate/[timestamp]_add_activation_to_users.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">AddActivationToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activation_digest</span><span class="p">,</span> <span class="ss">:string</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated_at</span><span class="p">,</span> <span class="ss">:datetime</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>然后像之前一样，执行迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>
<p>因为每个新注册的用户都得激活，所以我们应该在创建用户对象之前为用户分配激活令牌和摘要。类似的操作在 <a href="chapter6.html#uniqueness-validation">6.2.5 节</a>见过，那时我们要在用户存入数据库之前把电子邮件地址转换成小写形式。我们使用的是 <code>before_save</code> 回调和 <code>downcase</code> 方法（<a href="chapter6.html#listing-email-downcase">代码清单 6.31</a>）。<code>before_save</code> 回调在保存对象之前，包括创建对象和更新对象，自动调用。不过现在我们只想在创建用户之前调用回调，创建激活摘要。为此，我们要使用 <code>before_create</code> 回调，按照下面的方式定义：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</pre></div>
</div>
<p>这种写法叫“方法引用”，Rails 会寻找一个名为 <code>create_activation_digest</code> 的方法，在创建用户之前调用。（在<a href="chapter6.html#listing-email-downcase">代码清单 6.31</a> 中，我们直接把一个块传给 <code>before_save</code>。不过方法引用是推荐的做法。）<code>create_activation_digest</code> 方法只会在用户模型内使用，没必要公开。如 <a href="chapter7.html#strong-parameters">7.3.2 节</a>所示，在 Ruby 中可以使用 <code>private</code> 实现这个需求：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_activation_digest</span>
    <span class="c1"># 创建令牌和摘要</span>
  <span class="k">end</span>
</pre></div>
</div>
<p>在一个类中，<code>private</code> 之后的方法都会自动“隐藏”。我们可以在控制器会话中验证这一点：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_activation_digest</span>
<span class="go">NoMethodError: private method `create_activation_digest' called for #&lt;User&gt;</span>
</pre></div>
</div>
<p>这个 <code>before_create</code> 回调的作用是为用户分配令牌和对应的摘要，实现的方法如下所示：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
<span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</pre></div>
</div>
<p>这里用到了实现“记住我”功能时用来生成令牌和摘要的方法。我们可以把这两行代码和<a href="chapter8.html#listing-user-model-remember">代码清单 8.32</a> 中的 <code>remember</code> 方法比较一下：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="c1"># 为了持久会话，在数据库中记住用户</span>
<span class="k">def</span> <span class="nf">remember</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
  <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
<span class="k">end</span>
</pre></div>
</div>
<p>二者之间的主要区别是，<code>remember</code> 方法中使用的是 <code>update_attribute</code>。因为，创建记忆令牌和摘要时，用户已经存在于数据库中了，而 <code>before_create</code> 回调在创建用户之前执行。有了这个回调，使用 <code>User.new</code> 新建用户后（例如用户注册后，参见<a href="chapter7.html#listing-create-action-strong-parameters">代码清单 7.17</a>），会自动赋值 <code>activation_token</code> 和 <code>activation_digest</code> 属性，而且因为 <code>activation_digest</code> 对应数据库中的一个列（<a href="#fig-user-model-account-activation">图 10.1</a>），所以保存用户时会自动把属性的值存入数据库。</p>
<p>综上所述，用户模型如<a href="#listing-user-model-activation-code">代码清单 10.3</a> 所示。因为激活令牌是虚拟属性，所以我们又添加了一个 <code>attr_accessor</code>。注意，我们还把电子邮件地址转换成小写的回调改成了方法引用形式。</p>
<div id="listing-user-model-activation-code" data-type="listing">
<h5><span class="title-label">代码清单 10.3</span>：在用户模型中添加账户激活相关的代码 <span class="green">GREEN</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span>
</span><span class="hll">  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
</span><span class="hll">  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="c1"># 把电子邮件地址转换成小写</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</span>    <span class="k">end</span>

    <span class="c1"># 创建并赋值激活令牌和摘要</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>在继续之前，我们还要修改种子数据，把示例用户和测试用户设为已激活，如<a href="#listing-seed-users-activated">代码清单 10.4</a> 和<a href="#listing-fixture-users-activated">代码清单 10.5</a> 所示。（<code>Time.zone.now</code> 是 Rails 提供的辅助方法，基于服务器使用的时区，返回当前时间戳。）</p>
<div id="listing-seed-users-activated" data-type="listing">
<h5><span class="title-label">代码清单 10.4</span>：激活种子数据中的用户</h5>

<div class="source-file">db/seeds.rb</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">User.create!(name</span><span class="p-Indicator">:</span>  <span class="s">"Example</span><span class="nv"> </span><span class="s">User"</span><span class="err">,</span>
             <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">"example@railstutorial.org"</span><span class="err">,</span>
             <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>              <span class="s">"foobar"</span><span class="err">,</span>
             <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="s">"foobar"</span><span class="err">,</span>
             <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span>     <span class="l-Scalar-Plain">true,</span>
<span class="hll">             <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true,</span>
</span><span class="hll">             <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Time.zone.now)</span>
</span>
<span class="l-Scalar-Plain">99.times do |n|</span>
  <span class="l-Scalar-Plain">name  = Faker::Name.name</span>
  <span class="l-Scalar-Plain">email = "example-#{n+1}@railstutorial.org"</span>
  <span class="l-Scalar-Plain">password = "password"</span>
  <span class="l-Scalar-Plain">User.create!(name</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">name,</span>
              <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">email,</span>
              <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>              <span class="l-Scalar-Plain">password,</span>
              <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">password,</span>
<span class="hll">              <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true,</span>
</span><span class="hll">              <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Time.zone.now)</span>
</span><span class="l-Scalar-Plain">end</span>
</pre></div>
</div>
<div id="listing-fixture-users-activated" data-type="listing">
<h5><span class="title-label">代码清单 10.5</span>：激活固件中的用户</h5>

<div class="source-file">test/fixtures/users.yml</div>

<div class="highlight language-yaml"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
  <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">archer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sterling Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duchess@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">lana</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Lana Kane</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hands@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">malory</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Malory Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">boss@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
<span class="l-Scalar-Plain">user_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">&lt;%= "User</span> <span class="c1">#{n}" %&gt;</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= "user-#{n}@example.com" %&gt;</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span><span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</pre></div>
</div>
<p>为了应用<a href="#listing-seed-users-activated">代码清单 10.4</a> 中的改动，我们要还原数据库，然后像之前一样写入数据：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate:reset
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:seed
</pre></div>
</div>
</section>
<section data-type="sect2" id="account-activation-mailer-method">
<h2><span class="title-label">10.1.2</span> 邮件程序</h2>
<p>写好模型后，我们要编写发送账户激活邮件的代码了。我们要使用 Action Mailer 库创建一个邮件程序，在用户控制器的 <code>create</code> 动作中发送一封包含激活链接的邮件。邮件程序的结构和控制器动作差不多，邮件模板使用视图定义。这一节的任务是创建邮件程序，以及编写视图，写入激活账户所需的激活令牌和电子邮件地址。</p>
<p>与模型和控制器一样，我们可以使用 <code>rails generate</code> 生成邮件程序：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate mailer UserMailer account_activation password_reset
</pre></div>
</div>
<p>我们使用这个命令生成了所需的 <code>account_activation</code> 方法，以及 <a href="#password-reset">10.2 节</a>要使用的 <code>password_reset</code> 方法。</p>
<p>生成邮件程序时，Rails 还为每个邮件程序生成了两个视图模板，一个用于纯文本邮件，一个用于 HTML 邮件。账户激活邮件程序的两个视图如<a href="#listing-generated-account-activation-view-text">代码清单 10.6</a> 和<a href="#listing-generated-account-activation-view-html">代码清单 10.7</a> 所示。</p>
<div id="listing-generated-account-activation-view-text" data-type="listing">
<h5><span class="title-label">代码清单 10.6</span>：生成的账户激活邮件视图，纯文本格式</h5>

<div class="source-file">app/views/user_mailer/account_activation.text.erb</div>

<div class="highlight language-erb"><pre><span class="x">UserMailer#account_activation</span>

<span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span><span class="x">, find me in app/views/user_mailer/account_activation.text.erb</span>
</pre></div>
</div>
<div id="listing-generated-account-activation-view-html" data-type="listing">
<h5><span class="title-label">代码清单 10.7</span>：生成的账户激活邮件视图，HTML 格式</h5>

<div class="source-file">app/views/user_mailer/account_activation.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;h1&gt;UserMailer#account_activation&lt;/h1&gt;</span>

<span class="x">&lt;p&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span><span class="x">, find me in app/views/user_mailer/account_activation.html.erb</span>
<span class="x">&lt;/p&gt;</span>
</pre></div>
</div>
<p>我们看一下生成的邮件程序，了解它是如何工作的，如<a href="#listing-generated-application-mailer">代码清单 10.8</a> 和<a href="#listing-generated-user-mailer">代码清单 10.9</a>所示。代码<a href="#listing-generated-application-mailer">代码清单 10.8</a> 设置了一个默认的发件人地址（<code>from</code>），整个应用中的全部邮件程序都会使用这个地址。（这个代码清单还设置了各种邮件格式使用的布局。本书不会讨论邮件的布局，生成的 HTML 和纯文本格式邮件布局在 <code>app/views/layouts</code> 文件夹中。）<a href="#listing-generated-user-mailer">代码清单 10.9</a> 中的每个方法中都设置了收件人地址。在生成的代码中还有一个实例变量 <code>@greeting</code>，这个变量可在邮件程序的视图中使用，就像控制器中的实例变量可以在普通的视图中使用一样。</p>
<div id="listing-generated-application-mailer" data-type="listing">
<h5><span class="title-label">代码清单 10.8</span>：生成的 <code>ApplicationMailer</code></h5>

<div class="source-file">app/mailers/application_mailer.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"from@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-generated-user-mailer" data-type="listing">
<h5><span class="title-label">代码清单 10.9</span>：生成的 <code>UserMailer</code></h5>

<div class="source-file">app/mailers/user_mailer.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.account_activation.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.password_reset.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>为了发送激活邮件，我们首先要修改生成的模板，如<a href="#listing-application-mailer">代码清单 10.10</a> 所示。然后要创建一个实例变量，其值是用户对象，以便在视图中使用，然后把邮件发给 <code>user.email</code>。如<a href="#listing-mail-account-activation">代码清单 10.11</a> 所示，<code>mail</code> 方法还可以接受 <code>subject</code> 参数，指定邮件的主题。</p>
<div id="listing-application-mailer" data-type="listing">
<h5><span class="title-label">代码清单 10.10</span>：在 <code>ApplicationMailer</code> 中设定默认的发件人地址</h5>


<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"noreply@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-mail-account-activation" data-type="listing">
<h5><span class="title-label">代码清单 10.11</span>：发送账户激活链接</h5>

<div class="source-file">app/mailers/user_mailer.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

<span class="hll">  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Account activation"</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>

    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>和普通的视图一样，在邮件程序的视图中也可以使用嵌入式 Ruby。在邮件中我们要添加一个针对用户的欢迎消息，以及一个激活链接。我们计划使用电子邮件地址查找用户，然后使用激活令牌认证用户，所以链接中要包含电子邮件地址和令牌。因为我们把“账户激活”视作一个资源，所以可以把令牌作为参数传给<a href="#listing-account-activations-route">代码清单 10.1</a> 中定义的具名路由：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>
<p>我们知道，<code>edit_user_url(user)</code> 生成的地址是下面这种形式：</p>
<div data-type="listing">


<div class="highlight language-text"><pre>http://www.example.com/users/1/edit
</pre></div>
</div>
<p>那么，账户激活的链接应该是这种形式：</p>
<div data-type="listing">


<div class="highlight language-text"><pre>http://www.example.com/account_activations/q5lt38hQDc_959PVoo6b7A/edit
</pre></div>
</div>
<p>其中，<code>q5lt38hQDc_959PVoo6b7A</code> 是使用 <code>new_token</code> 方法（<a href="chapter8.html#listing-token-method">代码清单 8.31</a>）生成的 base64 字符串，可安全地在 URL 中使用。这个值的作用和 /users/1/edit 中的用户 ID 一样，在 <code>AccountActivationsController</code> 的 <code>edit</code> 动作中可以通过 <code>params[:id]</code> 获取。</p>
<p>为了包含电子邮件地址，我们要使用“查询参数”（query parameter）。查询参数放在 URL 中的问号后面，使用键值对形式指定：<sup>[<a id="fn-ref-6" href="#fn-6">6</a>]</sup></p>
<div data-type="listing">


<div class="highlight language-text"><pre>account_activations/q5lt38hQDc_959PVoo6b7A/edit?email=foo%40example.com
</pre></div>
</div>
<p>注意，电子邮件地址中的“@”被替换成了 <code>%40</code>，也就是被转义了，这样，URL 才是有效的。在 Rails 中设定查询参数的方法是，把一个哈希传给具名路由：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre></div>
</div>
<p>使用这种方式设定查询参数，Rails 会自动转义所有特殊字符。而且，在控制器中会自动反转义电子邮件地址，通过 <code>params[:email]</code> 可以获取电子邮件地址。</p>
<p>定义好实例变量 <code>@user</code> 之后（<a href="#listing-mail-account-activation">代码清单 10.11</a>），我们可以使用 <code>edit</code> 动作的具名路由和嵌入式 Ruby 创建所需的链接了，如<a href="#listing-account-activation-view-text">代码清单 10.12</a> 和<a href="#listing-account-activation-view-html">代码清单 10.13</a> 所示。注意，在<a href="#listing-account-activation-view-html">代码清单 10.13</a> 中，我们使用 <code>link_to</code> 方法创建有效的链接。</p>
<div id="listing-account-activation-view-text" data-type="listing">
<h5><span class="title-label">代码清单 10.12</span>：账户激活邮件的纯文本视图</h5>

<div class="source-file">app/views/user_mailer/account_activation.text.erb</div>

<div class="highlight language-erb"><pre><span class="x">Hi </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">,</span>

<span class="x">Welcome to the Sample App! Click on the link below to activate your account:</span>

<span class="cp">&lt;%=</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<div id="listing-account-activation-view-html" data-type="listing">
<h5><span class="title-label">代码清单 10.13</span>：账户激活邮件的 HTML 视图</h5>

<div class="source-file">app/views/user_mailer/account_activation.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;h1&gt;Sample App&lt;/h1&gt;</span>

<span class="x">&lt;p&gt;Hi </span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">,&lt;/p&gt;</span>

<span class="x">&lt;p&gt;</span>
<span class="x">Welcome to the Sample App! Click on the link below to activate your account:</span>
<span class="x">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Activate"</span><span class="p">,</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>
                                                    <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>若想查看这两个邮件视图的效果，我们可以使用邮件预览功能。Rails 提供了一些特殊的 URL，用来预览邮件。首先，我们要在应用的开发环境中添加一些设置，如<a href="#listing-development-email-settings">代码清单 10.14</a> 所示。</p>
<div id="listing-development-email-settings" data-type="listing">
<h5><span class="title-label">代码清单 10.14</span>：开发环境中的邮件设置</h5>

<div class="source-file">config/environments/development.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'example.com'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-development-email-settings">代码清单 10.14</a> 中设置的主机地址是 <code>'example.com'</code>，你应该使用你的开发环境的主机地址。例如，在我的系统中，可以使用下面的地址（包括云端 IDE 和本地服务器）：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">host</span> <span class="o">=</span> <span class="s1">'rails-tutorial-c9-mhartl.c9.io'</span>     <span class="c1"># 云端 IDE</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'localhost:3000'</span>                     <span class="c1"># 本地主机</span>
</pre></div>
</div>
<p>然后重启开发服务器，让<a href="#listing-development-email-settings">代码清单 10.14</a> 中的设置生效。接下来，我们要修改邮件程序的预览文件。生成邮件程序时已经自动生成了这个文件，如<a href="#listing-generated-user-mailer-previews">代码清单 10.15</a> 所示。</p>
<div id="listing-generated-user-mailer-previews" data-type="listing">
<h5><span class="title-label">代码清单 10.15</span>：生成的邮件预览程序</h5>

<div class="source-file">test/mailers/previews/user_mailer_preview.rb</div>

<div class="highlight language-ruby"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<p>因为<a href="#listing-mail-account-activation">代码清单 10.11</a> 中定义的 <code>account_activation</code> 方法需要一个有效的用户作为参数，所以<a href="#listing-generated-user-mailer-previews">代码清单 10.15</a> 中的代码现在还不能使用。为了解决这个问题，我们要定义 <code>user</code> 变量，把开发数据库中的第一个用户赋值给它，然后作为参数传给 <code>UserMailer.account_activation</code>，如<a href="#listing-account-activation-preview">代码清单 10.16</a> 所示。注意，在这段代码中，我们还给 <code>user.activation_token</code> 赋了值，因为<a href="#listing-account-activation-view-text">代码清单 10.12</a> 和<a href="#listing-account-activation-view-html">代码清单 10.13</a> 中的模板要使用账户激活令牌。（<code>activation_token</code> 是虚拟属性，所以数据库中的用户并没有激活令牌。）</p>
<div id="listing-account-activation-preview" data-type="listing">
<h5><span class="title-label">代码清单 10.16</span>：预览账户激活邮件所需的方法</h5>

<div class="source-file">test/mailers/previews/user_mailer_preview.rb</div>

<div class="highlight language-ruby"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>这样修改之后，我们就可以访问注释中提示的 URL 预览账户激活邮件了。（如果使用云端 IDE，要把 <code>localhost:3000</code> 换成相应的 URL。）HTML 和纯文本邮件分别如<a href="#fig-account-activation-html-preview">图 10.2</a> 和<a href="#fig-account-activation-text-preview">图 10.3</a> 所示。</p>
<div id="fig-account-activation-html-preview" class="figure"><img src="images/chapter10/account_activation_html_preview.png" alt="account activation html preview" /><div class="figcaption"><span class="title-label">图 10.2</span>：预览 HTML 格式的账户激活邮件</div></div>
<div id="fig-account-activation-text-preview" class="figure"><img src="images/chapter10/account_activation_text_preview.png" alt="account activation text preview" /><div class="figcaption"><span class="title-label">图 10.3</span>：预览纯文本格式的账户激活邮件</div></div>
<p>最后，我们要编写一些测试，再次确认邮件的内容。这并不难，因为 Rails 生成了一些有用的测试示例，如<a href="#listing-generated-user-mailer-test">代码清单 10.17</a> 所示。</p>
<div id="listing-generated-user-mailer-test" data-type="listing">
<h5><span class="title-label">代码清单 10.17</span>：Rails 生成的 <code>UserMailer</code> 测试</h5>

<div class="source-file">test/mailers/user_mailer_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-generated-user-mailer-test">代码清单 10.17</a> 中使用了强大的 <code>assert_match</code> 方法。这个方法既可以匹配字符串，也可以匹配正则表达式：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">assert_match</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># false</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'$#!*+@'</span>      <span class="c1"># false</span>
</pre></div>
</div>
<p><a href="#listing-real-account-activation-test">代码清单 10.18</a> 使用 <code>assert_match</code> 检查邮件正文中是否有用户的名字、激活令牌和转义后的电子邮件地址。注意，转义用户电子邮件地址使用的方法是 <code>CGI::escape(user.email)</code>。<sup>[<a id="fn-ref-7" href="#fn-7">7</a>]</sup>（其实还有第三种方法，<code>ERB::Util</code> 中的 <a href="http://apidock.com/ruby/ERB/Util/url_encode"><code>url_encode</code> 方法</a>有同样的效果。）</p>
<div id="listing-real-account-activation-test" data-type="listing">
<h5><span class="title-label">代码清单 10.18</span>：测试现在这个邮件程序 <span class="red">RED</span></h5>

<div class="source-file">test/mailers/user_mailer_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>               <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，我们在<a href="#listing-real-account-activation-test">代码清单 10.18</a> 中为用户固件指定了激活令牌，因为固件中没有虚拟属性。</p>
<p>为了让这个测试通过，我们要修改测试环境的配置，设定正确的主机地址，如<a href="#listing-test-domain-host">代码清单 10.19</a> 所示。</p>
<div id="listing-test-domain-host" data-type="listing">
<h5><span class="title-label">代码清单 10.19</span>：设定测试环境的主机地址</h5>

<div class="source-file">config/environments/test.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
<span class="hll">  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'example.com'</span> <span class="p">}</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在，邮件程序的测试应该可以通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.20</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>:mailers
</pre></div>
</div>
<p>若要在我们的应用中使用这个邮件程序，只需在处理用户注册的 <code>create</code> 动作中添加几行代码，如<a href="#listing-user-signup-with-account-activation">代码清单 10.21</a> 所示。注意，<a href="#listing-user-signup-with-account-activation">代码清单 10.21</a> 修改了注册后的重定向地址。之前，我们把用户重定向到资料页面（<a href="chapter7.html#successful-signups">7.4 节</a>），可是现在需要先激活，再转向这个页面就不合理了，所以把重定向地址改成了根地址。</p>
<div id="listing-user-signup-with-account-activation" data-type="listing">
<h5><span class="title-label">代码清单 10.21</span>：在注册过程中添加账户激活 <span class="red">RED</span></h5>

<div class="source-file">app/controllers/users_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span><span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>因为现在重定向到根地址而不是资料页面，而且不会像之前那样自动登入用户，所以测试组件无法通过，不过应用能按照我们设计的方式运行。我们暂时把导致失败的测试注释掉，如<a href="#listing-comment-out-failing-tests">代码清单 10.22</a> 所示。我们会在 <a href="#activation-test-and-refactoring">10.1.4 节</a>去掉注释，并且为账户激活编写能通过的测试。</p>
<div id="listing-comment-out-failing-tests" data-type="listing">
<h5><span class="title-label">代码清单 10.22</span>：临时注释掉失败的测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/users_signup_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post_via_redirect</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                            <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                            <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
<span class="hll">    <span class="c1"># assert_template 'users/show'</span>
</span><span class="hll">    <span class="c1"># assert is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如果现在注册，重定向后显示的页面如<a href="#fig-redirected-not-activated">图 10.4</a> 所示，而且会生成一封邮件，如<a href="#listing-account-activation-email">代码清单 10.23</a> 所示。注意，在开发环境中并不会真发送邮件，不过能在服务器的日志中看到（可能要往上滚动才能看到）。<a href="#email-in-production">10.3 节</a>会介绍如何在生产环境中发送邮件。</p>
<div id="listing-account-activation-email" data-type="listing">
<h5><span class="title-label">代码清单 10.23</span>：在服务器日志中看到的账户激活邮件</h5>


<div class="highlight language-text"><pre>Sent mail to michael@michaelhartl.com (931.6ms)
Date: Wed, 03 Sep 2014 19:47:18 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;540770474e16_61d3fd1914f4cd0300a0@mhartl-rails-tutorial-953753.mail&gt;
Subject: Account activation
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5407704656b50_61d3fd1914f4cd02996a";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5407704656b50_61d3fd1914f4cd02996a
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Hi Michael Hartl,

Welcome to the Sample App! Click on the link below to activate your account:

http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com
----==_mimepart_5407704656b50_61d3fd1914f4cd02996a
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;h1&gt;Sample App&lt;/h1&gt;

&lt;p&gt;Hi Michael Hartl,&lt;/p&gt;

&lt;p&gt;
Welcome to the Sample App! Click on the link below to activate your account:
&lt;/p&gt;

&lt;a href="http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com"&gt;Activate&lt;/a&gt;
----==_mimepart_5407704656b50_61d3fd1914f4cd02996a--
</pre></div>
</div>
<div id="fig-redirected-not-activated" class="figure"><img src="images/chapter10/redirected_not_activated.png" alt="redirected not activated" /><div class="figcaption"><span class="title-label">图 10.4</span>：注册后显示的首页，有一个提醒激活的消息</div></div>
</section>
<section data-type="sect2" id="activating-the-account">
<h2><span class="title-label">10.1.3</span> 激活账户</h2>
<p>现在可以正确生成电子邮件了（<a href="#listing-account-activation-email">代码清单 10.23</a>），接下来我们要编写 <code>AccountActivationsController</code> 中的 <code>edit</code> 动作，激活用户。<a href="#account-activation-mailer-method">10.1.2 节</a>说过，激活令牌和电子邮件地址可以分别通过 <code>params[:id]</code> 和 <code>params[:email]</code> 获取。参照密码（<a href="chapter8.html#listing-find-authenticate-user">代码清单 8.5</a>）和记忆令牌（<a href="chapter8.html#listing-persistent-current-user">代码清单 8.36</a>）的实现方式，我们计划使用下面的代码查找和认证用户：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>（稍后会看到，上述代码还缺一个判断条件。看看你能否猜到缺了什么。）</p>
<p>上述代码使用 <code>authenticated?</code> 方法检查账户激活的摘要和指定的令牌是否匹配，但是现在不起作用，因为 <code>authenticated?</code> 方法是专门用来认证记忆令牌的（<a href="chapter8.html#listing-authenticated-p">代码清单 8.33</a>）：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="c1"># 如果指定的令牌和摘要匹配，返回 true</span>
<span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>其中，<code>remember_digest</code> 是用户模型的属性，在模型内，我们可以将其改写成：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="nb">self</span><span class="o">.</span><span class="n">remember_digest</span>
</pre></div>
</div>
<p>我们希望以某种方式把这个值变成“变量”，这样才能调用 <code>self.activation_token</code>，而不是把合适的参数传给 <code>authenticated?</code> 方法。</p>
<p>我们要使用的解决方法涉及到“元编程”（metaprogramming），意思是用程序编写程序。（元编程是 Ruby 最强大的功能，Rails 中很多“神奇”的功能都是通过元编程实现的。）这里的关键是强大的 <code>send</code> 方法。这个方法的作用是在指定的对象上调用指定的方法。例如，在下面的控制台会话中，我们在一个 Ruby 原生对象上调用 <code>send</code> 方法，获取数组的长度：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:length</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'length'</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>
<p>可以看出，把 <code>:length</code> 符号或者 <code>'length'</code> 字符串传给 <code>send</code> 方法的作用和在对象上直接调用 <code>length</code> 方法的作用一样。再看一个例子，获取数据库中第一个用户的 <code>activation_digest</code> 属性：</p>
<div data-type="listing">


<div class="highlight language-irb"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">activation_digest</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:activation_digest</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'activation_digest'</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="hll"><span class="gp">&gt;&gt; </span><span class="n">attribute</span> <span class="o">=</span> <span class="ss">:activation</span>
</span><span class="hll"><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
</span><span class="hll"><span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
</span></pre></div>
</div>
<p>注意最后一种调用方式，我们定义了一个 <code>attribute</code> 变量，其值为符号 <code>:activation</code>，然后使用字符串插值构建传给 <code>send</code> 方法的参数。<code>attribute</code> 变量的值使用字符串 <code>'activation'</code> 也行，不过符号更便利。不管使用什么，插值后，<code>"#{attribute}_digest"</code> 的结果都是 <code>"activation_digest"</code>。（<a href="chapter7.html#the-flash">7.4.2 节</a>介绍过，插值时会把符号转换成字符串。）</p>
<p>基于上述对 <code>send</code> 方法的介绍，我们可以把 <code>authenticated?</code> 方法改写成：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'remember_digest'</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>以此为模板，我们可以为这个方法增加一个参数，代表摘要的名字，然后再使用字符串插值，扩大这个方法的用途：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>（我们把第二个参数的名字改成了 <code>token</code>，以此强调这个方法的用途更广。）因为这个方法在用户模型内，所以可以省略 <code>self</code>，得到更符合习惯写法的版本：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在我们可以像下面这样调用 <code>authenticated?</code> 方法实现以前的效果：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div>
</div>
<p>把修改后的 <code>authenticated?</code> 方法写入用户模型，如<a href="#listing-generalized-authenticated-p">代码清单 10.24</a> 所示。</p>
<div id="listing-generalized-authenticated-p" data-type="listing">
<h5><span class="title-label">代码清单 10.24</span>：用途更广的 <code>authenticated?</code> 方法 <span class="red">RED</span></h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 如果指定的令牌和摘要匹配，返回 true</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如<a href="#listing-generalized-authenticated-p">代码清单 10.24</a> 的标题所示，测试组件无法通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.25</span>：<strong class="red">RED</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>失败的原因是，<code>current_user</code> 方法（<a href="chapter8.html#listing-persistent-current-user">代码清单 8.36</a>）和摘要为 <code>nil</code> 的测试（<a href="chapter8.html#listing-test-authenticated-invalid-token">代码清单 8.43</a>）使用的都是旧版 <code>authenticated?</code>，期望传入的是一个参数而不是两个。因此，我们只需修改这两个地方，换用修改后的 <code>authenticated?</code> 方法就能解决这个问题，如<a href="#listing-generalized-current-user">代码清单 10.26</a> 和<a href="#listing-test-authenticated-invalid-token-updated">代码清单 10.27</a> 所示。</p>
<div id="listing-generalized-current-user" data-type="listing">
<h5><span class="title-label">代码清单 10.26</span>：在 <code>current_user</code> 中使用修改后的 <code>authenticated?</code> 方法 <span class="green">GREEN</span></h5>

<div class="source-file">app/helpers/sessions_helper.rb</div>

<div class="highlight language-ruby"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 返回当前登录的用户（如果有的话）</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-test-authenticated-invalid-token-updated" data-type="listing">
<h5><span class="title-label">代码清单 10.27</span>：在 <code>UserTest</code> 中使用修改后的 <code>authenticated?</code> 方法 <span class="green">GREEN</span></h5>

<div class="source-file">test/models/user_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>修改后，测试应该可以通过了：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.28</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>没有坚实的测试组件做后盾，像这样的重构很容易出错，所以我们才要在 <a href="chapter8.html#login-with-remembering">8.4.2 节</a>和 <a href="chapter8.html#remember-tests">8.4.6 节</a>排除万难编写测试。</p>
<p>有了<a href="#listing-generalized-authenticated-p">代码清单 10.24</a> 中定义的 <code>authenticated?</code> 方法，现在我们可以编写 <code>edit</code> 动作，认证 <code>params</code> 哈希中电子邮件地址对应的用户了。我们要使用的判断条件如下所示：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>注意，这里加入了 <code>!user.activated?</code>，就是前面提到的那个缺失的条件，作用是避免激活已经激活的用户。这个条件很重要，因为激活后我们要登入用户，但是不能让获得激活链接的攻击者以这个用户的身份登录。</p>
<p>如果通过了上述判断条件，我们要激活这个用户，并且更新 <code>activated_at</code> 中的时间戳：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</pre></div>
</div>
<p>据此，写出的 <code>edit</code> 动作如<a href="#listing-account-activation-edit-action">代码清单 10.29</a> 所示。注意，在<a href="#listing-account-activation-edit-action">代码清单 10.29</a> 中我们还处理了激活令牌无效的情况。这种情况很少发生，但处理起来也很容易，直接重定向到根地址即可。</p>
<div id="listing-account-activation-edit-action" data-type="listing">
<h5><span class="title-label">代码清单 10.29</span>：在 <code>edit</code> 动作中激活账户</h5>

<div class="source-file">app/controllers/account_activations_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>然后，复制粘贴<a href="#listing-account-activation-email">代码清单 10.23</a> 中的地址，应该就可以激活对应的用户了。例如，在我的系统中，我访问的地址是：</p>
<div data-type="listing">


<div class="highlight language-text"><pre>http://rails-tutorial-c9-mhartl.c9.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com
</pre></div>
</div>
<p>然后会看到如<a href="#fig-activated-user">图 10.5</a> 所示的页面。</p>
<div id="fig-activated-user" class="figure"><img src="images/chapter10/activated_user.png" alt="activated user" /><div class="figcaption"><span class="title-label">图 10.5</span>：成功激活后显示的资料页面</div></div>
<p>当然，现在激活用户后没有什么实际效果，因为我们还没修改用户登录的方式。为了让账户激活有实际意义，只能允许已经激活的用户登录，即 <code>user.activated?</code> 返回 <code>true</code> 时才能像之前那样登录，否则重定向到根地址，并且显示一个提醒消息（<a href="#fig-not-activated-warning">图 10.6</a>），如<a href="#listing-preventing-unactivated-logins">代码清单 10.30</a> 所示。</p>
<div id="listing-preventing-unactivated-logins" data-type="listing">
<h5><span class="title-label">代码清单 10.30</span>：禁止未激活的用户登录</h5>

<div class="source-file">app/controllers/sessions_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">        <span class="n">redirect_back_or</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">else</span>
</span><span class="hll">        <span class="n">message</span>  <span class="o">=</span> <span class="s2">"Account not activated. "</span>
</span><span class="hll">        <span class="n">message</span> <span class="o">+=</span> <span class="s2">"Check your email for the activation link."</span>
</span><span class="hll">        <span class="n">flash</span><span class="o">[</span><span class="ss">:warning</span><span class="o">]</span> <span class="o">=</span> <span class="n">message</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="fig-not-activated-warning" class="figure"><img src="images/chapter10/not_activated_warning.png" alt="not activated warning" /><div class="figcaption"><span class="title-label">图 10.6</span>：未激活用户试图登录后看到的提醒消息</div></div>
<p>至此，激活用户的功能基本完成了，不过还有个地方可以改进。（可以改进的是，不显示未激活的用户。这个改进留作<a href="#account-activation-and-password-reset-exercises">练习</a>。）<a href="#activation-test-and-refactoring">10.1.4 节</a>会编写一些测试，再做一些重构，完成整个功能。</p>
</section>
<section data-type="sect2" id="activation-test-and-refactoring">
<h2><span class="title-label">10.1.4</span> 测试和重构</h2>
<p>本节，我们要为账户激活功能添加一些集成测试。我们已经为提交有效信息的注册过程编写了测试，所以我们要把这个测试添加到 <a href="chapter7.html#a-test-for-valid-submission">7.4.4 节</a>编写的测试中（<a href="chapter7.html#listing-a-test-for-valid-submission">代码清单 7.26</a>）。在测试中，我们要添加好多步，不过意图都很明确，看看你是否能理解<a href="#listing-signup-with-account-activation-test">代码清单 10.31</a> 中的测试。</p>
<div id="listing-signup-with-account-activation-test" data-type="listing">
<h5><span class="title-label">代码清单 10.31</span>：在用户注册的测试文件中添加账户激活的测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/users_signup_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"valid signup information with account activation"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
<span class="hll">      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
</span>                               <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                               <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
    <span class="c1"># 尝试在激活之前登录</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># 激活令牌无效</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="s2">"invalid token"</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># 令牌有效，电子邮件地址不对</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'wrong'</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># 激活令牌有效</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">activated?</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>代码很多，不过有一行完全没见过：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
<p>这行代码确认只发送了一封邮件。<code>deliveries</code> 是一个数组，会统计所有发出的邮件，所以我们要在 <code>setup</code> 方法中把它清空，以防其他测试发送了邮件（<a href="#password-reset-test">10.2.5 节</a>就会这么做）。<a href="#listing-signup-with-account-activation-test">代码清单 10.31</a> 还第一次在本书正文中使用了 <code>assigns</code> 方法。<a href="chapter8.html#log-in-log-out-exercises">8.6 节</a>说过，<code>assigns</code> 的作用是获取相应动作中的实例变量。例如，用户控制器的 <code>create</code> 动作中定义了一个 <code>@user</code> 变量，那么我们可以在测试中使用 <code>assigns(:user)</code> 获取这个变量的值。最后，注意，<a href="#listing-signup-with-account-activation-test">代码清单 10.31</a> 把<a href="#listing-comment-out-failing-tests">代码清单 10.22</a> 中的注释去掉了。</p>
<p>现在，测试组件应该可以通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.32</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>有了<a href="#listing-signup-with-account-activation-test">代码清单 10.31</a> 中的测试做后盾，接下来我们可以稍微重构一下了：把处理用户的代码从控制器中移出，放入模型。我们会定义一个 <code>activate</code> 方法，用来更新用户激活相关的属性；还要定义一个 <code>send_activation_email</code> 方法，发送激活邮件。这两个方法的定义如<a href="#listing-user-activation-methods">代码清单 10.33</a> 所示，重构后的应用代码如<a href="#listing-user-signup-refactored">代码清单 10.34</a> 和<a href="#listing-account-activation-refactored">代码清单 10.35</a> 所示。</p>
<div id="listing-user-activation-methods" data-type="listing">
<h5><span class="title-label">代码清单 10.33</span>：在用户模型中添加账户激活相关的方法</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 激活账户</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 发送激活邮件</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-user-signup-refactored" data-type="listing">
<h5><span class="title-label">代码清单 10.34</span>：通过用户模型对象发送邮件</h5>

<div class="source-file">app/controllers/users_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="vi">@user</span><span class="o">.</span><span class="n">send_activation_email</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-account-activation-refactored" data-type="listing">
<h5><span class="title-label">代码清单 10.35</span>：通过用户模型对象激活账户</h5>

<div class="source-file">app/controllers/account_activations_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">user</span><span class="o">.</span><span class="n">activate</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>注意，在<a href="#listing-user-activation-methods">代码清单 10.33</a> 中没有使用 <code>user</code>。如果还像之前那样写就会出错，因为用户模型中没有这个变量：</p>
<div data-type="listing">


<div class="highlight language-diff"><pre><span class="gd">-user.update_attribute(:activated,    true)</span>
<span class="gd">-user.update_attribute(:activated_at, Time.zone.now)</span>
<span class="gi">+update_attribute(:activated,    true)</span>
<span class="gi">+update_attribute(:activated_at, Time.zone.now)</span>
</pre></div>
</div>
<p>（也可以把 <code>user</code> 换成 <code>self</code>，但 <a href="chapter6.html#uniqueness-validation">6.2.5 节</a>说过，在模型内可以不加 <code>self</code>。）调用 <code>UserMailer</code> 时，还把 <code>@user</code> 改成了 <code>self</code>：</p>
<div data-type="listing">


<div class="highlight language-diff"><pre><span class="gd">-UserMailer.account_activation(@user).deliver_now</span>
<span class="gi">+UserMailer.account_activation(self).deliver_now</span>
</pre></div>
</div>
<p>就算是简单的重构，也可能忽略这些细节，不过好的测试组件能捕获这些问题。现在，测试组件应该仍能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.36</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>账户激活功能完成了，我们取得了一定进展，可以提交了：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>git add -A
<span class="nv">$ </span>git commit -m <span class="s2">"Add account activations"</span>
</pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="password-reset">
<h1><span class="title-label">10.2</span> 密码重设</h1>
<p>完成账户激活功能后（从而确认了用户的电子邮件地址可用），我们要处理一种常见的问题：用户忘记密码。我们会看到，密码重设的很多步骤和账户激活类似，所以这里会用到 <a href="#account-activation">10.1 节</a>学到的知识。不过，开头不一样，和账户激活功能不同的是，密码重设要修改一个视图，还要创建两个表单（处理电子邮件地址提交和设定新密码）。</p>
<p>编写代码之前，我们先构思要实现的重设密码步骤。首先，我们要在演示应用的登录表单中添加“Forgot Password”（忘记密码）链接，如<a href="#fig-login-forgot-password-mockup">图 10.7</a> 所示。</p>
<div id="fig-login-forgot-password-mockup" class="figure"><img src="images/chapter10/login_forgot_password_mockup.png" alt="login forgot password mockup" /><div class="figcaption"><span class="title-label">图 10.7</span>：“Forgot Password”链接的构思图</div></div>
<p>点击“Forgot Password”链接后打开一个页面，这个页面中有一个表单，要求输入电子邮件地址，提交后向这个地址发送一封包含密码重设链接的邮件，如<a href="#fig-forgot-password-form-mockup">图 10.8</a> 所示。</p>
<div id="fig-forgot-password-form-mockup" class="figure"><img src="images/chapter10/forgot_password_form_mockup.png" alt="forgot password form mockup" /><div class="figcaption"><span class="title-label">图 10.8</span>：“Forgot Password”表单的构思图</div></div>
<p>点击密码重设链接会打开一个表单，用户在这个表单中重设密码（还要填写密码确认），如<a href="#fig-reset-password-form-mockup">图 10.9</a> 所示。</p>
<div id="fig-reset-password-form-mockup" class="figure"><img src="images/chapter10/reset_password_form_mockup.png" alt="reset password form mockup" /><div class="figcaption"><span class="title-label">图 10.9</span>：重设密码表单的构思图</div></div>
<p>和账户激活一样，我们要把“密码重设”看做一个资源，每个重设密码操作都有一个重设令牌和对应的摘要。主要的步骤如下：</p>
<ol class="arabic">
<li>
<p>用户请求重设密码时，使用提交的电子邮件地址查找用户；</p>
</li>
<li>
<p>如果数据库中有这个电子邮件地址，生成一个重设令牌和对应的摘要；</p>
</li>
<li>
<p>把重设摘要保存在数据库中，然后给用户发送一封邮件，其中有一包含重设令牌和用户电子邮件地址的链接；</p>
</li>
<li>
<p>用户点击这个链接后，使用电子邮件地址查找用户，然后对比令牌和摘要；</p>
</li>
<li>
<p>如果匹配，显示重设密码的表单。</p>
</li>
</ol>
<section data-type="sect2" id="password-resets-resource">
<h2><span class="title-label">10.2.1</span> 资源</h2>
<p>和账户激活一样（<a href="#account-activations-resource">10.1.1 节</a>），第一步要为资源生成控制器：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate controller PasswordResets new edit --no-test-framework
</pre></div>
</div>
<p>注意，我们指定了不生成测试的参数，因为我们不需要控制器测试（和 <a href="#activation-test-and-refactoring">10.1.4 节</a>一样，要使用集成测试），所以最好不生成。</p>
<p>我们需要两个表单，一个请求重设密码（<a href="#fig-forgot-password-form-mockup">图 10.8</a>），一个修改用户模型中的密码（<a href="#fig-reset-password-form-mockup">图 10.9</a>），所以需要为 <code>new</code>、<code>create</code>、<code>edit</code> 和 <code>update</code> 四个动作制定路由——通过<a href="#listing-password-resets-resource">代码清单 10.37</a> 中高亮显示的那行 <code>resources</code> 规则实现。</p>
<div id="listing-password-resets-resource" data-type="listing">
<h5><span class="title-label">代码清单 10.37</span>：添加“密码重设”资源的路由</h5>

<div class="source-file">config/routes.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div>
</div>
<p>添加这个规则后，得到了<a href="#table-restful-password-resets">表 10.2</a> 中的 REST 路由。</p>
<table id="table-restful-password-resets" class="tableblock frame-all grid-all" style="width: 100%;">
<caption><span class="title-label">表 10.2</span>：定义“密码重设”资源后得到的 REST 路由</caption>
<colgroup>
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
<col style="width: 25%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP 请求</th>
<th class="tableblock halign-left valign-top">URL</th>
<th class="tableblock halign-left valign-top">动作</th>
<th class="tableblock halign-left valign-top">具名路由</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/new</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>new_password_reset_path</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password_resets_path</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/&lt;token&gt;/edit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edit_password_reset_path(token)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PATCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/password_resets/&lt;token&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>password_reset_path(token)</code></p></td>
</tr>
</tbody>
</table>
<p>通过表中第一个路由可以得到指向“Forgot Password”表单的链接：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">new_password_reset_path</span>
</pre></div>
</div>
<p>把这个链接添加到登录表单，如<a href="#listing-log-in-password-reset">代码清单 10.38</a> 所示。添加后的效果如<a href="#fig-forgot-password-link">图 10.10</a> 所示。</p>
<div id="listing-log-in-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 10.38</span>：添加打开忘记密码表单的链接</h5>

<div class="source-file">app/views/sessions/new.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Log in&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"(forgot password)"</span><span class="p">,</span> <span class="n">new_password_reset_path</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        &lt;span&gt;Remember me on this computer&lt;/span&gt;</span>
<span class="x">      </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">    &lt;p&gt;New user? </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<div id="fig-forgot-password-link" class="figure"><img src="images/chapter10/forgot_password_link.png" alt="forgot password link" /><div class="figcaption"><span class="title-label">图 10.10</span>：添加“Forgot Password”链接后的登录页面</div></div>
<p>密码重设所需的数据模型和账户激活的类似（<a href="#fig-user-model-account-activation">图 10.1</a>）。参照“记住我”功能（<a href="chapter8.html#remember-me">8.4 节</a>）和账户激活功能（<a href="#account-activation">10.1 节</a>），密码重设需要一个虚拟的重设令牌属性，在重设密码的邮件中使用，以及一个重设摘要属性，用来取回用户。
如果存储未哈希的令牌，能访问数据库的攻击者就能发送一封重设密码邮件给用户，然后使用令牌和邮件地址访问对应的密码重设链接，从而获得账户控制权。因此，必须存储令牌的摘要。为了进一步保障安全，我们还计划过几个小时后让重设链接失效，所以要记录重设邮件发送的时间。据此，我们要添加两个属性：<code>reset_digest</code> 和 <code>reset_sent_at</code>，如<a href="#fig-user-model-password-reset">图 10.11</a> 所示。</p>
<div id="fig-user-model-password-reset" class="figure"><img src="images/chapter10/user_model_password_reset.png" alt="user model password reset" /><div class="figcaption"><span class="title-label">图 10.11</span>：添加密码重设相关属性后的用户模型</div></div>
<p>执行下面的命令，创建添加这两个属性的迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate migration add_reset_to_users reset_digest:string <span class="se">\</span>
&gt; reset_sent_at:datetime
</pre></div>
</div>
<p>然后像之前一样执行迁移：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>
</section>
<section data-type="sect2" id="password-resets-controller-and-form">
<h2><span class="title-label">10.2.2</span> 控制器和表单</h2>
<p>我们要参照前面为没有模型的资源编写表单的方法，即创建新会话的登录表单（<a href="chapter8.html#listing-login-form">代码清单 8.2</a>），编写请求重设密码的表单。为了便于参考，我们再把这个表单列出来，如<a href="#listing-login-form-redux">代码清单 10.39</a> 所示。</p>
<div id="listing-login-form-redux" data-type="listing">
<h5><span class="title-label">代码清单 10.39</span>：登录表单的代码</h5>

<div class="source-file">app/views/sessions/new.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Log in&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">        &lt;span&gt;Remember me on this computer&lt;/span&gt;</span>
<span class="x">      </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">    &lt;p&gt;New user? </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>请求重设密码的表单和<a href="#listing-login-form-redux">代码清单 10.39</a> 有很多共通之处，最大的区别是，<code>form_for</code> 中的资源和地址不一样，而且也没有密码字段。请求重设密码的表单如<a href="#listing-new-password-reset">代码清单 10.40</a> 所示，渲染的结果如<a href="#fig-forgot-password-form">图 10.12</a> 所示。</p>
<div id="listing-new-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 10.40</span>：请求重设密码页面的视图</h5>

<div class="source-file">app/views/password_resets/new.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Forgot password"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Forgot password&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:password_reset</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_resets_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Submit"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<div id="fig-forgot-password-form" class="figure"><img src="images/chapter10/forgot_password_form.png" alt="forgot password form" /><div class="figcaption"><span class="title-label">图 10.12</span>：“Forgot Password”表单</div></div>
<p>提交<a href="#fig-forgot-password-form">图 10.12</a> 中的表单后，我们要通过电子邮件地址查找用户，更新这个用户的 <code>reset_token</code>、<code>reset_digest</code> 和 <code>reset_sent_at</code> 属性，然后重定向到根地址，并显示一个闪现消息。和登录一样（<a href="chapter8.html#listing-correct-login-failure">代码清单 8.9</a>），如果提交的数据无效，我们要重新渲染这个页面，并且显示一个 <code>flash.now</code> 消息。据此，写出的 <code>create</code> 动作如<a href="#listing-create-password-reset">代码清单 10.41</a> 所示。</p>
<div id="listing-create-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 10.41</span>：<code>PasswordResetsController</code> 的 <code>create</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_reset</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">create_reset_digest</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">send_password_reset_email</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>然后要在用户模型中定义 <code>create_reset_digest</code> 方法，如<a href="#listing-user-model-password-reset">代码清单 10.42</a> 所示。</p>
<div id="listing-user-model-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 10.42</span>：在用户模型中添加重设密码所需的方法</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span><span class="p">,</span> <span class="ss">:reset_token</span>
</span>  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 激活账户</span>
  <span class="k">def</span> <span class="nf">activate</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 发送激活邮件</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># 设置密码重设相关的属性</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_digest</span><span class="p">,</span>  <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">reset_token</span><span class="p">))</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 发送密码重设邮件</span>
  <span class="k">def</span> <span class="nf">send_password_reset_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># 把电子邮件地址转换成小写</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>

    <span class="c1"># 创建并赋值激活令牌和摘要</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>如<a href="#fig-invalid-email-password-reset">图 10.13</a> 所示，提交无效电子邮件地址时，应用的表现正常。为了让提交有效地址时应用也能正常运行，我们要定义发送密码重设邮件的方法，这一步会在 <a href="#password-reset-mailer-method">10.2.3 节</a>完成。</p>
<div id="fig-invalid-email-password-reset" class="figure"><img src="images/chapter10/invalid_email_password_reset.png" alt="invalid email password reset" /><div class="figcaption"><span class="title-label">图 10.13</span>：提交无效电子邮件地址后显示的“Forgot Password”表单</div></div>
</section>
<section data-type="sect2" id="password-reset-mailer-method">
<h2><span class="title-label">10.2.3</span> 邮件程序</h2>
<p><a href="#listing-user-model-password-reset">代码清单 10.42</a> 中发送密码重设邮件的代码是：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</pre></div>
</div>
<p>让这个邮件程序运作起来所需的代码几乎和 <a href="#account-activation-mailer-method">10.1.2 节</a>的账户激活邮件程序一样。我们首先在 <code>UserMailer</code> 中定义 <code>password_reset</code> 方法（<a href="#listing-mail-password-reset">代码清单 10.43</a>），然后再编写邮件的纯文本视图（<a href="#listing-password-reset-text">代码清单 10.44</a>）和 HTML 视图（<a href="#listing-password-reset-html">代码清单 10.45</a>）。</p>
<div id="listing-mail-password-reset" data-type="listing">
<h5><span class="title-label">代码清单 10.43</span>：发送密码重设链接</h5>

<div class="source-file">app/mailers/user_mailer.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"noreply@example.com"</span>

  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Account activation"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Password reset"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-password-reset-text" data-type="listing">
<h5><span class="title-label">代码清单 10.44</span>：密码重设邮件的纯文本视图</h5>

<div class="source-file">app/views/user_mailer/password_reset.text.erb</div>

<div class="highlight language-erb"><pre><span class="x">To reset your password click the link below:</span>

<span class="cp">&lt;%=</span> <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">This link will expire in two hours.</span>

<span class="x">If you did not request your password to be reset, please ignore this email and</span>
<span class="x">your password will stay as it is.</span>
</pre></div>
</div>
<div id="listing-password-reset-html" data-type="listing">
<h5><span class="title-label">代码清单 10.45</span>：密码重设邮件的 HTML 视图</h5>

<div class="source-file">app/views/user_mailer/password_reset.html.erb</div>

<div class="highlight language-erb"><pre><span class="x">&lt;h1&gt;Password reset&lt;/h1&gt;</span>

<span class="x">&lt;p&gt;To reset your password click the link below:&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Reset password"</span><span class="p">,</span>
            <span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span>
                                    <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">&lt;p&gt;This link will expire in two hours.&lt;/p&gt;</span>

<span class="x">&lt;p&gt;</span>
<span class="x">If you did not request your password to be reset, please ignore this email and</span>
<span class="x">your password will stay as it is.</span>
<span class="x">&lt;/p&gt;</span>
</pre></div>
</div>
<p>和账户激活邮件一样（<a href="#account-activation-mailer-method">10.1.2 节</a>），我们可以使用 Rails 提供的邮件预览程序预览密码重设邮件。参照<a href="#listing-account-activation-preview">代码清单 10.16</a>，密码重设的邮件预览程序如<a href="#listing-password-reset-preview">代码清单 10.46</a> 所示。</p>
<div id="listing-password-reset-preview" data-type="listing">
<h5><span class="title-label">代码清单 10.46</span>：预览密码重设邮件所需的方法</h5>

<div class="source-file">test/mailers/previews/user_mailer_preview.rb</div>

<div class="highlight language-ruby"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>然后就可以预览密码重设邮件了，HTML 格式和纯文本格式分别如<a href="#fig-password-reset-html-preview">图 10.14</a> 和<a href="#fig-password-reset-text-preview">图 10.15</a> 所示。</p>
<div id="fig-password-reset-html-preview" class="figure"><img src="images/chapter10/password_reset_html_preview.png" alt="password reset html preview" /><div class="figcaption"><span class="title-label">图 10.14</span>：预览 HTML 格式的密码重设邮件</div></div>
<div id="fig-password-reset-text-preview" class="figure"><img src="images/chapter10/password_reset_text_preview.png" alt="password reset text preview" /><div class="figcaption"><span class="title-label">图 10.15</span>：预览纯文本格式的密码重设邮件</div></div>
<p>参照账户激活邮件程序的测试（<a href="#listing-real-account-activation-test">代码清单 10.18</a>），密码重设邮件程序的测试如<a href="#listing-password-reset-mailer-test">代码清单 10.47</a> 所示。注意，我们要创建密码重设令牌，以便在视图中使用。这一点和激活令牌不一样，激活令牌使用 <code>before_create</code> 回调创建（<a href="#listing-user-model-activation-code">代码清单 10.3</a>），但是密码重设令牌只会在用户成功提交“Forgot Password”表单后创建。在集成测试中很容易创建密码重设令牌（参见<a href="#listing-password-reset-integration-test">代码清单 10.54</a>），但在邮件程序的测试中必须手动创建。</p>
<div id="listing-password-reset-mailer-test" data-type="listing">
<h5><span class="title-label">代码清单 10.47</span>：添加密码重设邮件程序的测试 <span class="green">GREEN</span></h5>

<div class="source-file">test/mailers/user_mailer_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>               <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span>    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span>        <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">::</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在，测试组件应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.48</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
<p>有了<a href="#listing-mail-password-reset">代码清单 10.43</a>、<a href="#listing-password-reset-text">代码清单 10.44</a> 和<a href="#listing-password-reset-html">代码清单 10.45</a> 之后，提交有效电子邮件地址后显示的页面如<a href="#fig-valid-email-password-reset">图 10.16</a> 所示。服务器日志中记录的邮件类似于<a href="#listing-password-reset-email">代码清单 10.49</a>。</p>
<div id="fig-valid-email-password-reset" class="figure"><img src="images/chapter10/valid_email_password_reset.png" alt="valid email password reset" /><div class="figcaption"><span class="title-label">图 10.16</span>：提交有效电子邮件地址后显示的页面</div></div>
<div id="listing-password-reset-email" data-type="listing">
<h5><span class="title-label">代码清单 10.49</span>：服务器日志中记录的一封密码重设邮件</h5>


<div class="highlight language-text"><pre>Sent mail to michael@michaelhartl.com (66.8ms)
Date: Thu, 04 Sep 2014 01:04:59 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;5407babbee139_8722b257d04576a@mhartl-rails-tutorial-953753.mail&gt;
Subject: Password reset
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5407babbe3505_8722b257d045617";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

To reset your password click the link below:

http://rails-tutorial-c9-mhartl.c9.io/password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com

This link will expire in two hours.

If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
----==_mimepart_5407babbe3505_8722b257d045617
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;h1&gt;Password reset&lt;/h1&gt;

&lt;p&gt;To reset your password click the link below:&lt;/p&gt;

&lt;a href="http://rails-tutorial-c9-mhartl.c9.io/
password_resets/3BdBrXeQZSWqFIDRN8cxHA/
edit?email=michael%40michaelhartl.com"&gt;Reset password&lt;/a&gt;

&lt;p&gt;This link will expire in two hours.&lt;/p&gt;

&lt;p&gt;
If you did not request your password to be reset, please ignore this email and
your password will stay as it is.
&lt;/p&gt;
----==_mimepart_5407babbe3505_8722b257d045617--
</pre></div>
</div>
</section>
<section data-type="sect2" id="resetting-the-password">
<h2><span class="title-label">10.2.4</span> 重设密码</h2>
<p>为了让下面这种形式的链接生效，我们要编写一个表单，重设密码。</p>
<div data-type="listing">


<div class="highlight language-text"><pre>http://example.com/password_resets/3BdBrXeQZSWqFIDRN8cxHA/edit?email=foo%40bar.com
</pre></div>
</div>
<p>这个表单的目的和编辑用户资料的表单（<a href="chapter9.html#listing-user-edit-view">代码清单 9.2</a>）类似，不过现在只需更新密码和密码确认字段。而且处理起来有点复杂，因为我们希望通过电子邮件地址查找用户，也就是说，在 <code>edit</code> 动作和 <code>update</code> 动作中都需要使用邮件地址。在 <code>edit</code> 动作中可以轻易的获取邮件地址，因为链接中有。可是提交表单后，邮件地址就没有了。为了解决这个问题，我们可以使用一个“隐藏字段”，把这个字段的值设为邮件地址（不会显示），和表单中的其他数据一起提交给 <code>update</code> 动作，如<a href="#listing-password-reset-form">代码清单 10.50</a> 所示。</p>
<div id="listing-password-reset-form" data-type="listing">
<h5><span class="title-label">代码清单 10.50</span>：重设密码的表单</h5>

<div class="source-file">app/views/password_resets/edit.html.erb</div>

<div class="highlight language-erb"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Reset password'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;h1&gt;Reset password&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>
<span class="x">  &lt;div class="col-md-6 col-md-offset-3"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="hll"><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="x"></span>
</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Update password"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
<p>注意，在<a href="#listing-password-reset-form">代码清单 10.50</a> 中，使用的表单字段辅助方法是</p>
<div data-type="listing">


<div class="highlight language-erb"><pre><span class="x">hidden_field_tag :email, @user.email</span>
</pre></div>
</div>
<p>而不是</p>
<div data-type="listing">

<pre class="highlight language-erb"><code>f.hidden_field :email, @user.email</code></pre>

</div>
<p>因为在重设密码的链接中，邮件地址在 <code>params[:email]</code> 中，如果使用后者，就会把邮件地址放入 <code>params[:user][:email]</code> 中。</p>
<p>为了正确渲染这个表单，我们要在 <code>PasswordResetsController</code> 的 <code>edit</code> 控制器中定义 <code>@user</code> 变量。和账户激活一样（<a href="#listing-account-activation-edit-action">代码清单 10.29</a>），我们要找到 <code>params[:email]</code> 中电子邮件地址对应的用户，确认这个用户已经激活，然后使用<a href="#listing-generalized-authenticated-p">代码清单 10.24</a> 中的 <code>authenticated?</code> 方法认证 <code>params[:id]</code> 中的令牌。因为在 <code>edit</code> 和 <code>update</code> 动作中都要使用 <code>@user</code>，所以我们要把查找用户和认证令牌的代码写入一个事前过滤器中，如<a href="#listing-password-reset-edit-action">代码清单 10.51</a> 所示。</p>
<div id="listing-password-reset-edit-action" data-type="listing">
<h5><span class="title-label">代码清单 10.51</span>：重设密码的 <code>edit</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class="hll">  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">get_user</span>
<span class="hll">      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="k">end</span>

    <span class="c1"># 确保是有效用户</span>
    <span class="k">def</span> <span class="nf">valid_user</span>
<span class="hll">      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span>
</span><span class="hll">              <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-password-reset-edit-action">代码清单 10.51</a> 中的 <code>authenticated?(:reset, params[:id])</code>，<a href="#listing-generalized-current-user">代码清单 10.26</a> 中的 <code>authenticated?(:remember, cookies[:remember_token])</code>，以及<a href="#listing-account-activation-edit-action">代码清单 10.29</a> 中的 <code>authenticated?(:activation, params[:id])</code>，就是<a href="#table-password-token-digest">表 10.1</a> 中 <code>authenticated?</code> 方法的三个用例。</p>
<p>现在，点击<a href="#listing-password-reset-email">代码清单 10.49</a> 中的链接后，会显示密码重设表单，如<a href="#fig-password-reset-form">图 10.17</a> 所示。</p>
<div id="fig-password-reset-form" class="figure"><img src="images/chapter10/password_reset_form.png" alt="password reset form" /><div class="figcaption"><span class="title-label">图 10.17</span>：密码重设表单</div></div>
<p><code>edit</code> 动作对应的 <code>update</code> 动作要考虑四种情况：密码重设超时失效，重设成功，密码无效导致的重设失败，密码和密码确认为空值时导致的密码重设失败（此时看起来像是成功了）。前三种情况对应<a href="#listing-password-reset-update-action">代码清单 10.52</a> 中外层 <code>if</code> 语句的三个分支。因为这个表单会修改 Active Record 模型（用户模型），所以我们可以使用共用的局部视图渲染错误消息。密码为空值的情况比较特殊，因为用户模型的验证允许出现这种情况（参见<a href="chapter9.html#listing-allow-blank-password">代码清单 9.10</a>），所以要特别处理，直接在 <code>@user</code> 对象的错误消息中添加一个错误：<sup>[<a id="fn-ref-8" href="#fn-8">8</a>]</sup></p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="s2">"can't be empty"</span><span class="p">)</span>
</pre></div>
</div>
<div id="listing-password-reset-update-action" data-type="listing">
<h5><span class="title-label">代码清单 10.52</span>：重设密码的 <code>update</code> 动作</h5>

<div class="source-file">app/controllers/password_resets_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:get_user</span><span class="p">,</span>         <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:valid_user</span><span class="p">,</span>       <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:check_expiration</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_reset</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">create_reset_digest</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">send_password_reset_email</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email sent with password reset instructions"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Email address not found"</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
<span class="hll">    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:password</span><span class="o">].</span><span class="n">empty?</span>
</span>      <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="s2">"can't be empty"</span><span class="p">)</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
<span class="hll">    <span class="k">elsif</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span>      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password has been reset."</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
<span class="hll">      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</span>    <span class="k">end</span>

    <span class="c1"># 事前过滤器</span>

    <span class="k">def</span> <span class="nf">get_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># 确保是有效用户</span>
<span class="hll">    <span class="k">def</span> <span class="nf">valid_user</span>
</span>      <span class="k">unless</span> <span class="p">(</span><span class="vi">@user</span> <span class="o">&amp;&amp;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span>
              <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:reset</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
        <span class="n">redirect_to</span> <span class="n">root_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># 检查重设令牌是否过期</span>
<span class="hll">    <span class="k">def</span> <span class="nf">check_expiration</span>
</span>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_expired?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password reset has expired."</span>
        <span class="n">redirect_to</span> <span class="n">new_password_reset_url</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>我们把密码重设是否超时失效交给用户模型判断：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_expired?</span>
</pre></div>
</div>
<p>所以，我们要定义 <code>password_reset_expired?</code> 方法。如 <a href="#password-reset-mailer-method">10.2.3 节</a>的邮件模板所示，如果邮件发出后两个小时内没重设密码，就认为此次请求超时失效了。这个设想可以通过下面的 Ruby 代码实现：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</pre></div>
</div>
<p>如果你把 <code>&lt;</code> 当成小于号，读成“密码重设邮件发出少于两小时”就错了，和想表达的意思正好相反。
这里，最好把 <code>&lt;</code> 理解成“超过”，读成“密码重设邮件已经发出超过两小时”，这才是我们想表达的意思。<code>password_reset_expired?</code> 方法的定义如<a href="#listing-user-model-password-reset-expired">代码清单 10.53</a> 所示。（对这个比较算式的证明参见 <a href="#proof-of-expiration-comparison">10.6 节</a>。）</p>
<div id="listing-user-model-password-reset-expired" data-type="listing">
<h5><span class="title-label">代码清单 10.53</span>：在用户模型中定义 <code>password_reset_expired?</code> 方法</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 如果密码重设超时失效了，返回 true</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
<span class="hll">    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>现在，<a href="#listing-password-reset-update-action">代码清单 10.52</a> 中的 <code>update</code> 动作可以使用了。密码重设失败和成功后显示的页面分别如<a href="#fig-password-reset-failure">图 10.18</a> 和<a href="#fig-password-reset-success">图 10.19</a> 所示。（稍等一会，<a href="#account-activation-and-password-reset-exercises">10.5 节</a>中有一题，为第三个分支编写测试。）</p>
<div id="fig-password-reset-failure" class="figure"><img src="images/chapter10/password_reset_failure.png" alt="password reset failure" /><div class="figcaption"><span class="title-label">图 10.18</span>：密码重设失败</div></div>
<div id="fig-password-reset-success" class="figure"><img src="images/chapter10/password_reset_success.png" alt="password reset success" /><div class="figcaption"><span class="title-label">图 10.19</span>：密码重设成功</div></div>
</section>
<section data-type="sect2" id="password-reset-test">
<h2><span class="title-label">10.2.5</span> 测试</h2>
<p>本节，我们要编写一个集成测试，覆盖<a href="#listing-password-reset-update-action">代码清单 10.52</a> 中的两个分支：重设失败和重设成功。（前面说过，第三个分支的测试留作练习。）首先，为重设密码生成一个测试文件：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>rails generate integration_test password_resets
      invoke  test_unit
      create    <span class="nb">test</span>/integration/password_resets_test.rb
</pre></div>
</div>
<p>这个测试的步骤大致和<a href="#listing-signup-with-account-activation-test">代码清单 10.31</a> 中的账户激活测试差不多，不过开头有点不同。首先访问“Forgot Password”表单，分别提交有效和无效的电子邮件地址，电子邮件地址有效时要创建密码重设令牌，并且发送重设邮件。然后，访问邮件中的链接，分别提交无效和有效的密码，验证各自的表现是否正确。最终写出的测试如<a href="#listing-password-reset-integration-test">代码清单 10.54</a> 所示。这是一个不错的练习，可以锻炼阅读代码的能力。</p>
<div id="listing-password-reset-integration-test" data-type="listing">
<h5><span class="title-label">代码清单 10.54</span>：密码重设的集成测试</h5>

<div class="source-file">test/integration/password_resets_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password resets"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># 电子邮件地址无效</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/new'</span>
    <span class="c1"># 电子邮件地址有效</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>
    <span class="n">assert_not_equal</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reset_digest</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">reset_digest</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 密码重设表单</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="c1"># 电子邮件地址错误</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 用户未激活</span>
    <span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:activated</span><span class="p">)</span>
    <span class="c1"># 电子邮件地址正确，令牌不对</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="s1">'wrong token'</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
    <span class="c1"># 电子邮件地址正确，令牌也对</span>
    <span class="n">get</span> <span class="n">edit_password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'password_resets/edit'</span>
    <span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="c1"># 密码和密码确认不匹配</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobaz"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"barquux"</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 密码为空值</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="c1"># 密码和密码确认有效</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobaz"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobaz"</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-password-reset-integration-test">代码清单 10.54</a> 中的大多数用法前面都见过，但是针对 <code>input</code> 标签的测试有点陌生：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="n">assert_select</span> <span class="s2">"input[name=email][type=hidden][value=?]"</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
</pre></div>
</div>
<p>这行代码的意思是，页面中有 <code>name</code> 属性、类型（隐藏）和电子邮件地址都正确的 <code>input</code> 标签：</p>
<div data-type="listing">


<div class="highlight language-html"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"email"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"michael@example.com"</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>现在，测试组件应该能通过：</p>
<div data-type="listing">
<h5><span class="title-label">代码清单 10.55</span>：<strong class="green">GREEN</strong></h5>


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</pre></div>
</div>
</section>
</section>
<section data-type="sect1" id="email-in-production">
<h1><span class="title-label">10.3</span> 在生产环境中发送邮件</h1>
<p>我们已经成功实现了账户激活和密码重设功能，本节要配置应用，让它在生产环境中能真正地发送邮件。我们首先搭建一个免费的邮件服务，然后配置应用，最后再部署。</p>
<p>我们要在生产环境中使用 SendGrid 服务发送邮件。这个服务是 Heroku 的扩展，只有通过认证的账户才能使用。（要在 Heroku 的账户中填写信用卡信息，不过认证不收费。）对我们的应用来说，入门套餐（免费，写作本书时限制每天最多只能发送 400 封邮件）就够了。我们可以使用下面的命令添加这个扩展：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>heroku addons:create sendgrid:starter
</pre></div>
</div>
<p>为了让应用使用 SendGrid 发送邮件，我们要配置生产环境的 <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">SMTP</a> 设置，而且还要定义一个 <code>host</code> 变量，设置生产环境中网站的地址，如<a href="#listing-sendgrid-config">代码清单 10.56</a> 所示。</p>
<div id="listing-sendgrid-config" data-type="listing">
<h5><span class="title-label">代码清单 10.56</span>：配置应用在生产环境中使用 SendGrid</h5>

<div class="source-file">config/environments/production.rb</div>

<div class="highlight language-ruby"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'&lt;your heroku app&gt;.herokuapp.com'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span> <span class="p">}</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s1">'smtp.sendgrid.net'</span><span class="p">,</span>
    <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_USERNAME'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_PASSWORD'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="s1">'heroku.com'</span><span class="p">,</span>
    <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#listing-sendgrid-config">代码清单 10.56</a> 中设置了 SendGrid 账户的用户名（<code>user_name</code>）和密码（<code>password</code>），但是注意，这两个值是从 <code>ENV</code> 环境变量中获取的，而没有直接写入代码。这是生产环境应用的最佳实践，为了安全，绝不能在源码中写入敏感信息，例如原始密码。这两个值由 SendGrid 扩展自动设置，<a href="chapter11.html#image-upload-in-production">11.4.4 节</a>会介绍如何自己定义。如果好奇，可以使用下面的命令查看这两个环境变量的值：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>heroku config:get SENDGRID_USERNAME
<span class="nv">$ </span>heroku config:get SENDGRID_PASSWORD
</pre></div>
</div>
<p>现在，应该把主题分支合并到主分支中：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="nv">$ </span>git add -A
<span class="nv">$ </span>git commit -m <span class="s2">"Add password resets &amp; email configuration"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge account-activation-password-reset
</pre></div>
</div>
<p>然后，推送到远程仓库，再部署到 Heroku：</p>
<div data-type="listing">


<div class="highlight language-sh"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="nv">$ </span>git push
<span class="nv">$ </span>git push heroku master
<span class="nv">$ </span>heroku run rake db:migrate
</pre></div>
</div>
<p>配置好 SendGrid 服务后，在生产环境的演示应用中使用你的电子邮件注册试试。你应该会收到一封激活邮件，如<a href="#fig-activation-email-production">图 10.20</a> 所示。如果忘记密码（或者假装忘了），可以使用 <a href="#password-reset">10.2 节</a>实现的功能重设密码，收到的重设邮件如<a href="#fig-reset-email-production">图 10.21</a> 所示。</p>
<div id="fig-activation-email-production" class="figure"><img src="images/chapter10/activation_email_production.png" alt="activation email production" /><div class="figcaption"><span class="title-label">图 10.20</span>：生产环境中的应用发送的账户激活邮件</div></div>
<div id="fig-reset-email-production" class="figure"><img src="images/chapter10/reset_email_production.png" alt="reset email production" /><div class="figcaption"><span class="title-label">图 10.21</span>：生产环境中的应用发送的密码重设邮件</div></div>
</section>
<section data-type="sect1" id="account-activation-and-password-reset-conclusion">
<h1><span class="title-label">10.4</span> 小结</h1>
<p>实现账户激活和密码重设功能后，我们的演示应用已经完整实现了“注册-登录-退出”机制，而且是专业级的。本书剩下的章节以此为基础，实现类似 Twitter 的微博（<a href="chapter11.html#user-microposts">第 11 章</a>）和所关注用户发布的微博列表（<a href="chapter12.html#following-users">第 12 章</a>）。在实现的过程中，我们会学到一些 Rails 提供的强大功能，例如使用 <code>has_many</code> 和 <code>has_many :through</code> 实现的高级数据模型。</p>
<section data-type="sect2" id="account-activation-and-password-reset-learned">
<h2><span class="title-label">10.4.1</span> 读完本章学到了什么</h2>
<ul>
<li>
<p>和会话一样，账户激活虽然没有对应的 Active Record 对象，但也可以看做一个“资源”；</p>
</li>
<li>
<p>Rails 可以生成 Action Mailer 动作和视图，用于发送邮件；</p>
</li>
<li>
<p>Action Mailer 支持纯文本邮件和 HTML 邮件；</p>
</li>
<li>
<p>与普通的动作和视图一样，在邮件程序的视图中也可以使用邮件程序动作中的实例变量；</p>
</li>
<li>
<p>与会话和账户激活一样，密码重设虽然没有对应的 Active Record 对象，但也可以看做一个“资源”；</p>
</li>
<li>
<p>账户激活和密码重设都使用生成的令牌创建唯一的 URL，分别用于激活账户和重设密码；</p>
</li>
<li>
<p>邮件程序的测试和集成测试对确认邮件程序的表现都有用；</p>
</li>
<li>
<p>在生产环境可以使用 SendGrid 发送电子邮件。</p>
</li>
</ul>
</section>
</section>
<section data-type="sect1" id="account-activation-and-password-reset-exercises">
<h1><span class="title-label">10.5</span> 练习</h1>
<p>避免练习和正文冲突的方法参见<a href="chapter3.html#mostly-static-pages-exercises">3.6 节</a>中的说明。</p>
<ol class="arabic">
<li>
<p>填写<a href="#listing-password-reset-expire-test">代码清单 10.57</a> 中缺少的代码，为<a href="#listing-password-reset-update-action">代码清单 10.52</a> 中的密码重设超时失效分支编写集成测试。（<a href="#listing-password-reset-expire-test">代码清单 10.57</a> 用到了 <code>response.body</code>，用来获取返回页面中的 HTML。）检查是否过期有很多方法，<a href="#listing-password-reset-expire-test">代码清单 10.57</a> 使用的方法是，检查响应主体中是否包含单词“expired”（不区分大小写）。</p>
</li>
<li>
<p>现在，用户列表页面会显示所有用户，而且各用户还可以通过 /users/:id 查看。不过，更合理的做法是只显示已激活的用户。填写<a href="#listing-show-only-active-users-exercise">代码清单 10.58</a> 中缺少的代码，实现这一需求。<sup>[<a id="fn-ref-9" href="#fn-9">9</a>]</sup>（这段代码中使用了 Active Record 提供的 <code>where</code> 方法，<a href="chapter11.html#a-proto-feed">11.3.3 节</a>会详细介绍。）附加题：为 /users 和 /users/:id 编写集成测试。</p>
</li>
<li>
<p>在<a href="#listing-user-model-password-reset">代码清单 10.42</a> 中，<code>activate</code> 和 <code>create_reset_digest</code> 方法中都调用了两次 <code>update_attribute</code> 方法，每一次调用都要单独执行一个数据库事务（transaction）。填写<a href="#listing-update-columns">代码清单 10.59</a> 中缺少的代码，把两个 <code>update_attribute</code> 调用换成一个 <code>update_columns</code> 调用，这样修改后每个方法只会和数据库交互一次。然后再运行测试组件，确保仍能通过。</p>
</li>
</ol>
<div id="listing-password-reset-expire-test" data-type="listing">
<h5><span class="title-label">代码清单 10.57</span>：测试密码重设超时失效了 <span class="green">GREEN</span></h5>

<div class="source-file">test/integration/password_resets_test.rb</div>

<div class="highlight language-ruby"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">PasswordResetsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"expired token"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">new_password_reset_path</span>
    <span class="n">post</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">password_reset</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span>

    <span class="vi">@user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:reset_sent_at</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="n">patch</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reset_token</span><span class="p">),</span>
          <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
          <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span> <span class="p">}</span>
    <span class="n">assert_response</span> <span class="ss">:redirect</span>
    <span class="n">follow_redirect!</span>
<span class="hll">    <span class="n">assert_match</span> <span class="sr">/FILL_IN/i</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-show-only-active-users-exercise" data-type="listing">
<h5><span class="title-label">代码清单 10.58</span>：只显示已激活用户的代码模板</h5>

<div class="source-file">app/controllers/users_controller.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">unless</span> <span class="no">FILL_IN</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<div id="listing-update-columns" data-type="listing">
<h5><span class="title-label">代码清单 10.59</span>：使用 <code>update_columns</code> 的代码模板</h5>

<div class="source-file">app/models/user.rb</div>

<div class="highlight language-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span><span class="p">,</span> <span class="ss">:reset_token</span>
  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 激活账户</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="ss">activated_at</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 发送激活邮件</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="c1"># 设置密码重设相关的属性</span>
  <span class="k">def</span> <span class="nf">create_reset_digest</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">reset_digest</span><span class="p">:</span>  <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                   <span class="ss">reset_sent_at</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># 发送密码重设邮件</span>
  <span class="k">def</span> <span class="nf">send_password_reset_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section data-type="sect1" id="proof-of-expiration-comparison">
<h1><span class="title-label">10.6</span> 证明超时失效的比较算式</h1>
<p>本节我们要证明 <a href="#resetting-the-password">10.2.4 节</a>比较密码重设超时失效的算式是正确的。我们先来定义两个时间间隔：<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="4ex" height="2.5ex" viewbox="0 -739.9 1691.5 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E2-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E2-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E2-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E2-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E2-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-3B3" x="517" y="-213"></use>
</g>
</g>
</svg>
 表示发送密码重设邮件后经过的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="3.833ex" height="2.167ex" viewbox="0 -739.9 1637 918.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E2-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E2-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E2-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E2-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E2-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>
 表示限制的失效时长（例如两个小时）。如果邮件发出后经过的时间比限制的失效时长长，说明此次密码重设请求已经失效，即：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="10.833ex" height="2.5ex" viewbox="0 -739.9 4667.1 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1969" y="0"></use>
 <use xlink:href="#E1-MJMAIN-394" x="3030" y="0"></use>
<g transform="translate(3868,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>如果用 <svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="2.5ex" height="1.833ex" viewbox="0 -649.9 1097.4 820.9" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
</svg>
表示现在的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="4ex" height="2.5ex" viewbox="0 -739.9 1691.5 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E2-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E2-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E2-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E2-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E2-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-3B3" x="517" y="-213"></use>
</g>
</g>
</svg>
 表示发送邮件的时间，<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="1.833ex" height="2ex" viewbox="0 -649.9 799 828.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</svg>
 表示失效的时间（例如两个小时以前），那么：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="14.5ex" height="2.5ex" viewbox="0 -739.9 6208.4 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="1969" y="0"></use>
<g transform="translate(3030,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="4349" y="0"></use>
<g transform="translate(5354,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="14.167ex" height="2.167ex" viewbox="0 -739.9 6099.5 918.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="1914" y="0"></use>
<g transform="translate(2975,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="4295" y="0"></use>
<g transform="translate(5300,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>把这两个等式代入第一个算式：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="10.833ex" height="2.5ex" viewbox="0 -739.9 4667.1 1063.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-394" x="0" y="0"></use>
<g transform="translate(838,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1969" y="0"></use>
 <use xlink:href="#E1-MJMAIN-394" x="3030" y="0"></use>
<g transform="translate(3868,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="17.667ex" height="2.333ex" viewbox="0 -649.9 7640.9 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2212" x="1319" y="0"></use>
<g transform="translate(2324,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="3456" y="0"></use>
<g transform="translate(4516,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="5836" y="0"></use>
<g transform="translate(6841,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="10.667ex" height="2.333ex" viewbox="0 -649.9 4557.1 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2212" x="0" y="0"></use>
<g transform="translate(783,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3E" x="1914" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2212" x="2975" y="0"></use>
<g transform="translate(3758,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>在这个不等式的两边乘于 -1 后得到：</p>
<div data-type="equation">

<svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.833ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="7ex" height="2.333ex" viewbox="0 -649.9 2991.1 973.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-3B3" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"></path>
<path stroke-width="10" id="E1-MJMAIN-3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-3B3" x="517" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-3C" x="1131" y="0"></use>
<g transform="translate(2192,0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</g>
</svg>

</div>
<p>把 <svg xmlns:xlink="http://www.w3.org/1999/xlink" style="vertical-align: -0.5ex; margin-left: 0ex; margin-right: 0ex; margin-bottom: 1px; margin-top: 1px;" width="1.833ex" height="2ex" viewbox="0 -649.9 799 828.7" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="10" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="10" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="517" y="-213"></use>
</g>
</svg>
 = 2.hours.ago 代入这个不等式后就能得到<a href="#listing-user-model-password-reset-expired">代码清单 10.53</a> 中的 <code>password_reset_expired?</code> 方法：</p>
<div data-type="listing">


<div class="highlight language-ruby"><pre><span class="k">def</span> <span class="nf">password_reset_expired?</span>
  <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
<span class="k">end</span>
</pre></div>
</div>
<p><a href="#resetting-the-password">10.2.4 节</a>说过，如果把 <code>&lt;</code> 理解成“超过”而不是“小于号”的话，就能得到一个符合人类逻辑的句子：“密码重设邮件已经发出超过两小时”。</p>
</section>
</section>
                </article>

                <div class="navi clearfix">
                    
                        <div class="pull-left">
                            <a class="prev" href="chapter9.html" title="第 9 章 更新，显示和删除用户">&laquo; 第 9 章 更新，显示和删除用户</a>
                        </div>
                    
                    
                        <div class="pull-right">
                            <a class="next" href="chapter11.html" title="第 11 章 用户的微博">第 11 章 用户的微博 &raquo; </a>
                        </div>
                    
                </div>

                <div class="footnotes">
<ol>
<li id="fn-1">严格来说，用户可以使用 <a href="chapter9.html#updating-users">9.1 节</a>实现的个人资料更新功能，把电子邮件地址改为不正确的地址。不过目前的实现方式无需过多工作就能验证电子邮件地址。 <a href="#fn-ref-1" class="symbol">&#8617;</a></li>
<li id="fn-2">也可以使用用户的 ID，因为应用的 URL 已经暴露了 ID，但是电子邮件地址更灵活，说不定以后你想隐藏 ID 呢（例如，防止竞争对手知道你的应用中有多少用户）。 <a href="#fn-ref-2" class="symbol">&#8617;</a></li>
<li id="fn-3">或许在 <code>update</code> 动作中处理更合理，但是激活链接要在邮件中发送，应该是个普通的点击操作，发送的是 <code>GET</code> 请求，而不是向 <code>update</code> 动作发送 <code>PATCH</code> 请求。 <a href="#fn-ref-3" class="symbol">&#8617;</a></li>
<li id="fn-4">虽然我们要使用 <code>edit</code> 动作，但如果在命令行中指定 <code>edit</code>，就会生成相应的视图和测试文件，而我们并不需要这两个文件。 <a href="#fn-ref-4" class="symbol">&#8617;</a></li>
<li id="fn-5">例如，如果攻击者能访问数据库，就能激活新注册的用户，然后以这个用户的身份登录，接着修改密码，获取控制权。 <a href="#fn-ref-5" class="symbol">&#8617;</a></li>
<li id="fn-6">URL 中可以有多个查询参数，多个键值对之间使用 <code>&amp;</code> 符号连接，例如 <code>/edit?name=Foo%20Bar&amp;email=foo%40example.com</code>。 <a href="#fn-ref-6" class="symbol">&#8617;</a></li>
<li id="fn-7">为了查明该怎么做，可以在谷歌中搜索“ruby rails escape url”。你会找到<a href="http://stackoverflow.com/questions/6714196/ruby-url-encoding-string">两种主要方法</a>：<code>URI::encode(str)</code> 和 <code>CGI.escape(str)</code>。一一试过之后，会发现需要的是第二个方法。 <a href="#fn-ref-7" class="symbol">&#8617;</a></li>
<li id="fn-8">只需处理密码为空值的情况，因为如果密码确认为空，密码确认字段的验证（如果密码为空，会跳过这个验证）会捕获这个问题，并显示相关的错误消息。 <a href="#fn-ref-8" class="symbol">&#8617;</a></li>
<li id="fn-9">注意，<a href="#listing-show-only-active-users-exercise">代码清单 10.58</a> 中使用的是 <code>and</code> 而不是 <code>&amp;&amp;</code>。二者作用基本一样，但 <code>&amp;&amp;</code> 的<a href="http://en.wikipedia.org/wiki/Order_of_operations#Programming_languages">优先级</a>较高，和 <code>root_url</code> 绑定的太紧。我们也可以把 <code>redirect_to root_url</code> 放在括号里，不过习惯写法是使用 <code>and</code>。 <a href="#fn-ref-9" class="symbol">&#8617;</a></li>
</ol>
</div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <p>&copy;2013-2015 <a href="http://about.ac" title="安道的网站">安道</a></p>
    <p class="sns"><a href="https://twitter.com/andor_chen" title="安道的 Twitter"><i class="fa fa-twitter"></i></a> <a href="http://weibo.com/andor27" title="安道的微博"><i class="fa fa-weibo"></i></a></p>
    <p>保留部分权利，禁止转载</p>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56255794-2', 'auto');
  ga('send', 'pageview');
  $('#navbar-purchase').on('click',function(){
    ga('send', 'event', 'button', 'click', 'navbar purchase');
  });
  $('#navbar-purchase-xs').on('click',function(){
    ga('send', 'event', 'button', 'click', 'navbar purchase xs');
  });
</script>

</body>
</html>
